name: Build OpenWrt for JD BE6500 (IPQ5332)

on:
  workflow_dispatch:  
    inputs:
      with_wsdd2:
        description: 'ÁºñËØëÂåÖÂê´ WSDD2 (SMB3 ÊîØÊåÅ)'
        required: false
        default: 'true'
        type: boolean
      with_samba4:
        description: 'ÁºñËØëÂåÖÂê´ Samba4'
        required: false
        default: 'true'
        type: boolean
      with_docker:
        description: 'ÁºñËØëÂåÖÂê´ Docker ÊîØÊåÅ'
        required: false
        default: 'true'
        type: boolean
  release:
    types: published  

env:
  LIENOL_REPO: https://github.com/Lienol/openwrt          
  LIENOL_BRANCH: 23.05                                  
  ARCH: ipq5332                                          
  SUBARCH: generic                                       
  CPU_ARCH: aarch64_cortex-a53                           
  FEEDS_CONF: feeds.conf.default                         
  CONFIG_FILE: .config                                   
  DIY_P1_SH: diy-part1.sh                                
  DIY_P2_SH: diy-part2.sh                                
  UPLOAD_BIN_DIR: false                                  
  UPLOAD_FIRMWARE: true                                  
  UPLOAD_RELEASE: true                                   
  UPLOAD_CDN: false                                      
  TZ: Asia/Shanghai                                      
  GITHUB_TOKEN: ${{ secrets.MY_TOKEN }}                  
  CACHE_DIR: ${{ github.workspace }}/.cache/openwrt       

jobs:
  build:
    runs-on: ubuntu-22.04                                 

    steps:
    - name: Ê£ÄÊü•ÁéØÂ¢É
      run: |
        df -hT
        free -h
        cat /proc/cpuinfo
        cat /etc/os-release

    - name: ÂÆâË£ÖOpenWrtÁºñËØë‰æùËµñ
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3 python3-distutils python3-setuptools \
          python3-dev rsync subversion swig time unzip wget xmlto zlib1g-dev \
          quilt autopoint libtool-bin gperf flex bison gettext-base asciidoc dos2unix \
          python3-pyelftools python3-pip
        pip install pyelftools

    - name: ÈÖçÁΩÆGitÂá≠ËØÅ
      run: |
        git config --global credential.helper store
        echo "https://${GITHUB_TOKEN}:@github.com" > ~/.git-credentials
        echo "GitÂá≠ËØÅÂ∑≤ÈÖçÁΩÆ"
    - name: Ê∏ÖÁêÜÂ∑•‰ΩúÁõÆÂΩï
      run: |
        rm -rf openwrt
        mkdir -p openwrt
    - name: ÂÖãÈöÜLienol‰ªìÂ∫ìÔºàÂ∏¶ÈáçËØïÊú∫Âà∂Ôºâ
      run: |
        rm -rf openwrt
        for i in {1..5}; do
          echo "=== Á¨¨ $i Ê¨°ÂÖãÈöÜÂ∞ùËØï ==="
          git clone --depth=1 $LIENOL_REPO -b $LIENOL_BRANCH openwrt
          if [ $? -eq 0 ]; then
            echo "‚úÖ ‰ªìÂ∫ìÂÖãÈöÜÊàêÂäü"
            break
          fi
          echo "‚ùå ÂÖãÈöÜÂ§±Ë¥•Ôºå15ÁßíÂêéÈáçËØï..."
          sleep 15
        done
        if [ ! -d "openwrt" ]; then
          echo "üí• ‰∫îÊ¨°ÂÖãÈöÜÂ§±Ë¥•ÔºåÈÄÄÂá∫"
          exit 1
        fi
        cd openwrt
        echo "OPENWRT_PATH=$(pwd)" >> $GITHUB_ENV
        git log -1
         # Á°Æ‰øùÂÖãÈöÜÂà∞Ê≠£Á°ÆÁõÆÂΩï
        if [ ! -d ".git" ]; then
         echo "‚ùå ÂÖãÈöÜÁõÆÂΩï‰∏çÊ≠£Á°ÆÔºåÈÄÄÂá∫"
         exit 1
         fi

    - name: ÁºìÂ≠ò‰æùËµñÂåÖÔºàÂä†ÈÄüÁºñËØëÔºâ
      uses: actions/cache@v3
      with:
        path: ${{ env.CACHE_DIR }}
        # key: ${{ runner.os }}-openwrt-dl-${{ hashFiles('openwrt/dl/**', 'feeds.conf.default', '.config') }}
        key: ${{ runner.os }}-openwrt-dl-${{ hashFiles('feeds.conf.default', '.config', 'target/linux/ipq5332/**') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-dl-

    - name: Êô∫ËÉΩFeedsÈÖçÁΩÆÔºàÂéªÈáç+ÂÆòÊñπÊ∫ê‰ºòÂÖàÔºâ
      run: |
        cd $OPENWRT_PATH
        cp $FEEDS_CONF ${FEEDS_CONF}.bak  # Â§á‰ªΩÂéüÈÖçÁΩÆ
        #> $FEEDS_CONF  # Ê∏ÖÁ©∫Áé∞ÊúâÈÖçÁΩÆÔºåÈáçÊñ∞ÊûÑÂª∫
        # ÂÖàÁßªÈô§ÈáçÂ§çÊ∫êÔºàÂèØÈÄâÔºâ
        grep -v "lienol\|packages\|luci\|qca" $FEEDS_CONF > ${FEEDS_CONF}.tmp
        mv ${FEEDS_CONF}.tmp $FEEDS_CONF
        
        # Ê∑ªÂä†LienolÂÆòÊñπÊ∫ê
        echo "src-git lienol https://github.com/Lienol/openwrt-package" >> $FEEDS_CONF
        
        # OpenWrtÂÆòÊñπÊ∫êÔºàÊòéÁ°ÆÁâàÊú¨ÔºåÈÅøÂÖçÂÜ≤Á™ÅÔºâ
        #echo "src-git packages https://git.openwrt.org/feed/packages.git^openwrt-23.05" >> $FEEDS_CONF
        #echo "src-git luci https://git.openwrt.org/project/luci.git^openwrt-23.05" >> $FEEDS_CONF
        echo "src-git packages1 https://git.openwrt.org/feed/packages.git#openwrt-23.05" >> $FEEDS_CONF
        echo "src-git luci1 https://git.openwrt.org/project/luci.git#openwrt-23.05" >> $FEEDS_CONF
        echo "src-git routing1 https://git.openwrt.org/feed/routing.git#openwrt-23.05" >> $FEEDS_CONF
        echo "src-git telephony1 https://git.openwrt.org/feed/telephony.git#openwrt-23.05" >> $FEEDS_CONF
        echo "src-git wireless1 https://git.openwrt.org/feed/wireless.git#openwrt-23.05" >> $FEEDS_CONF
        
        # IPQ5332‰∏ìÂ±ûÈ©±Âä®Ê∫êÔºàÂÆòÊñπQCA‰ªìÂ∫ìÔºâ
        #echo "src-git qca https://git.openwrt.org/project/qca.git^openwrt-23.05" >> $FEEDS_CONF
        echo "src-git qca https://git.openwrt.org/project/qca.git#openwrt-23.05" >> $FEEDS_CONF
        # Ê∑ªÂä†Á¨¨‰∏âÊñπËΩØ‰ª∂ÂåÖÊ∫ê
        echo "src-git kenzo1 https://github.com/kenzok8/openwrt-packages#openwrt-23.05" >> $FEEDS_CONF
        echo "src-git small1 https://github.com/kenzok8/small#openwrt-23.05" >> $FEEDS_CONF
        echo "src-git passwall1 https://github.com/xiaorouji/openwrt-passwall#master" >> $FEEDS_CONF
        echo "src-git helloworld1 https://github.com/fw876/helloworld#master" >> $FEEDS_CONF
        
        echo "=== ÊúÄÁªàFeedsÈÖçÁΩÆ ==="
        cat $FEEDS_CONF

    - name: ‰æùËµñÂº∫ÂåñÂÆâË£ÖÔºàÂÆòÊñπÊ∫ê‰ºòÂÖàÔºådebugÁ∫ßËæìÂá∫Ôºâ
      run: |
        cd $OPENWRT_PATH
        rm -rf feeds/*  # Ê∏ÖÁêÜÊóßFeeds
        
        # Â§öËΩÆÊõ¥Êñ∞ÔºàÂ∫îÂØπÁΩëÁªúÊ≥¢Âä®Ôºâ
        for i in {1..3}; do
          echo "=== Á¨¨ $i Ê¨°FeedsÊõ¥Êñ∞ ==="
          rm -rf feeds/*
          ./scripts/feeds update  2>&1 | tee feeds_update_${i}.log
          if [ $? -eq 0 ]; then
            break
          fi
          echo "Êõ¥Êñ∞Â§±Ë¥•Ôºå10ÁßíÂêéÈáçËØï..."
          sleep 10
        done
        
        # Êåâ‰ºòÂÖàÁ∫ßÂÆâË£ÖFeedsÔºàÁ°Æ‰øùÂÆòÊñπÂåÖ‰ºòÂÖàÔºâ
        ./scripts/feeds install -p packages 
        ./scripts/feeds install  -p luci 
        ./scripts/feeds install  -p routing 
        ./scripts/feeds install  -p telephony 
        ./scripts/feeds install  -p wireless 
        ./scripts/feeds install  -p qca 
        # ‰ºòÂÖàÂÆâË£ÖQCAÈ©±Âä®
        ./scripts/feeds install -p qca kmod-ath11k-ct kmod-ath11k-firmware-qca64 kmod-qca-nss-drv kmod-qca-nss-gmac kmod-qca-ppe kmod-thermal-qcom
        
        # Âº∫Âà∂ÂÆâË£ÖIPQ5332ÂÖ≥ÈîÆÈ©±Âä®
        #./scripts/feeds install -f -p wireless kmod-ath11k-ct 
        #./scripts/feeds install -f -p wireless kmod-ath11k-firmware-qca64 
        #./scripts/feeds install -f -p qca kmod-qca-nss-drv 
        #./scripts/feeds install -f -p qca kmod-qca-nss-gmac 
        #./scripts/feeds install -f -p qca kmod-qca-ppe 
        #./scripts/feeds install -f -p qca kmod-thermal-qcom
        +   # ÂÖàÊ£ÄÊü•qca feed‰∏≠ÊòØÂê¶Â≠òÂú®È©±Âä®
        if ./scripts/feeds list | grep -q "kmod-ath11k-ct"; then
          ./scripts/feeds install -f -p qca kmod-ath11k-ct kmod-ath11k-firmware-qca64
        else
          ./scripts/feeds install -f -p wireless kmod-ath11k-ct kmod-ath11k-firmware-qca64
        fi
        ./scripts/feeds install -f -p qca kmod-qca-nss-drv kmod-qca-nss-gmac kmod-qca-ppe kmod-thermal-qcom

        # È©±Âä®Â≠òÂú®ÊÄßÈ™åËØÅ
        if ! ls feeds | grep -q "kmod-ath11k-ct"; then
          echo "‚ùå ÂÖ≥ÈîÆÈ©±Âä®kmod-ath11k-ctÊú™ÂÆâË£ÖÔºåÈÄÄÂá∫"
          exit 1
        fi
        if ! ls feeds | grep -q "kmod-qca-nss-drv"; then
          echo "‚ùå ÂÖ≥ÈîÆÈ©±Âä®kmod-qca-nss-drvÊú™ÂÆâË£ÖÔºåÈÄÄÂá∫"
          exit 1
        fi
        
        # ÂÆâË£ÖÁ¨¨‰∏âÊñπËΩØ‰ª∂ÂåÖ
        ./scripts/feeds install -a -p kenzo 
        ./scripts/feeds install -a -p small 
        
        # Ê£ÄÊü•IPQ5332È©±Âä®ÊòØÂê¶Â≠òÂú®
        if ! ./scripts/feeds list | grep -q "kmod-ath11k-ct"; then
          echo "‚ö†Ô∏è Êú™ÊâæÂà∞ath11kÈ©±Âä®ÔºåÂº∫Âà∂‰ªéwirelessÊ∫êÂÆâË£Ö..."
          ./scripts/feeds install -f -p wireless kmod-ath11k-ct 
          
          # ÂÜçÊ¨°Ê£ÄÊü•
          if ! ./scripts/feeds list | grep -q "kmod-ath11k-ct"; then
            echo "‚ùå ‰ªçÊú™ÊâæÂà∞È©±Âä®ÔºåÊâãÂä®ÊûÑÂª∫ath11k-ct Makefile..."
            mkdir -p package/kernel/ath11k-ct
            
            # ÈÄêË°åÁîüÊàêMakefileÔºàÊó†cat EOFÔºâ
            echo 'include $(TOPDIR)/rules.mk' > package/kernel/ath11k-ct/Makefile
            echo 'include $(INCLUDE_DIR)/kernel.mk' >> package/kernel/ath11k-ct/Makefile
            echo '' >> package/kernel/ath11k-ct/Makefile
            echo 'PKG_NAME:=ath11k-ct' >> package/kernel/ath11k-ct/Makefile
            echo 'PKG_VERSION:=2023.05' >> package/kernel/ath11k-ct/Makefile
            echo 'PKG_RELEASE:=1' >> package/kernel/ath11k-ct/Makefile
            echo '' >> package/kernel/ath11k-ct/Makefile
            echo 'PKG_SOURCE_URL:=https://git.openwrt.org/project/libs/ath11k-ct.git' >> package/kernel/ath11k-ct/Makefile
            echo 'PKG_SOURCE_PROTO:=git' >> package/kernel/ath11k-ct/Makefile
            echo 'PKG_SOURCE_VERSION:=openwrt-23.05' >> package/kernel/ath11k-ct/Makefile
            echo 'PKG_MIRROR_HASH:=skip' >> package/kernel/ath11k-ct/Makefile
            echo '' >> package/kernel/ath11k-ct/Makefile
            echo 'PKG_MAINTAINER:=John Doe <john@example.com>' >> package/kernel/ath11k-ct/Makefile
            echo 'PKG_LICENSE:=GPL-2.0-only' >> package/kernel/ath11k-ct/Makefile
            echo 'PKG_LICENSE_FILES:=LICENSE' >> package/kernel/ath11k-ct/Makefile
            echo '' >> package/kernel/ath11k-ct/Makefile
            echo 'include $(INCLUDE_DIR)/package.mk' >> package/kernel/ath11k-ct/Makefile
            echo '' >> package/kernel/ath11k-ct/Makefile
            echo 'define KernelPackage/ath11k-ct' >> package/kernel/ath11k-ct/Makefile
            echo '  SUBMENU:=Wireless Drivers' >> package/kernel/ath11k-ct/Makefile
            echo '  TITLE:=Atheros ath11k wireless driver (CT version)' >> package/kernel/ath11k-ct/Makefile
            echo '  DEPENDS:=+kmod-cfg80211 +kmod-usb-core +kmod-mac80211' >> package/kernel/ath11k-ct/Makefile
            echo '  KCONFIG:= \' >> package/kernel/ath11k-ct/Makefile
            echo '    CONFIG_ATH11K=m \' >> package/kernel/ath11k-ct/Makefile
            echo '    CONFIG_ATH11K_DEBUGFS=n \' >> package/kernel/ath11k-ct/Makefile
            echo '    CONFIG_ATH11K_TRACE=n' >> package/kernel/ath11k-ct/Makefile
            echo '  FILES:=$(PKG_BUILD_DIR)/compat.ko $(PKG_BUILD_DIR)/ath11k.ko' >> package/kernel/ath11k-ct/Makefile
            echo '  AUTOLOAD:=$(call AutoProbe,ath11k)' >> package/kernel/ath11k-ct/Makefile
            echo 'endef' >> package/kernel/ath11k-ct/Makefile
            echo '' >> package/kernel/ath11k-ct/Makefile
            echo 'define KernelPackage/ath11k-ct/description' >> package/kernel/ath11k-ct/Makefile
            echo '  This package contains the Atheros ath11k wireless driver' >> package/kernel/ath11k-ct/Makefile
            echo '  for newer Qualcomm Atheros chipsets.' >> package/kernel/ath11k-ct/Makefile
            echo 'endef' >> package/kernel/ath11k-ct/Makefile
            echo '' >> package/kernel/ath11k-ct/Makefile
            echo '$(eval $(call KernelPackage,ath11k-ct))' >> package/kernel/ath11k-ct/Makefile
            
            echo "‚úÖ ÊâãÂä®ÊûÑÂª∫ath11k-ct MakefileÂÆåÊàê"
          else
            echo "‚úÖ ‰ªéwirelessÊ∫êÂº∫Âà∂ÂÆâË£Öath11kÈ©±Âä®ÊàêÂäü"
          fi
        else
          echo "‚úÖ IPQ5332 Wi-FiÈ©±Âä®Â∑≤ÈÄöËøáFeedsÂÆâË£Ö"
        fi

    - name: Âü∫Á°ÄÈÖçÁΩÆÁîüÊàêÔºàÂº∫Âà∂ÁõÆÊ†áÂπ≥Âè∞Ôºâ
      run: |
        cd $OPENWRT_PATH
        if [ -f "$CONFIG_FILE" ]; then
          echo "‚úÖ ÂèëÁé∞Â∑≤Êúâ.configÔºåÊõ¥Êñ∞ÁõÆÊ†áÂπ≥Âè∞ÈÖçÁΩÆ"
          cp $CONFIG_FILE ${CONFIG_FILE}.bak
          sed -i '/CONFIG_TARGET_IPQ807X/d' $CONFIG_FILE
          sed -i '/CONFIG_TARGET_IPQ807X_DEVICE_jd-be6500/d' $CONFIG_FILE
        else
          echo "‚ùå Êú™ÂèëÁé∞.configÔºåÁîüÊàêÈªòËÆ§ÈÖçÁΩÆ"
          make defconfig
        fi
        
        # Âº∫Âà∂ÂÜôÂÖ•ÁõÆÊ†áÂπ≥Âè∞ÈÖçÁΩÆ
        echo "CONFIG_TARGET_IPQ807X=y" >> $CONFIG_FILE
        echo "CONFIG_TARGET_IPQ807X_DEVICE_jd-be6500=y" >> $CONFIG_FILE
        echo "CONFIG_TARGET_DEVICE_PACKAGES_jd-be6500=\"kmod-ath11k-ct kmod-qca-ppe kmod-qca-nss-drv kmod-qca-nss-gmac kmod-thermal-qcom\"" >> $CONFIG_FILE
        echo "CONFIG_TARGET_KERNEL_PARTSIZE=32" >> $CONFIG_FILE
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=256" >> $CONFIG_FILE
        
        echo "=== ÂΩìÂâç.config ËÆæÂ§áÈÖçÁΩÆ ==="
        grep -E "CONFIG_TARGET_IPQ807X_DEVICE|CONFIG_TARGET_DEVICE_PACKAGES" .config

    - name: ËÆæÂ§áÊ†ëÂº∫Âà∂ÂÖ≥ËÅîÔºàÁ∫ØechoÂÆûÁé∞Ôºâ
      run: |
        cd $OPENWRT_PATH
        DTS_DIR="target/linux/$ARCH/dts"
        mkdir -p "$DTS_DIR"
        DEVICE_TREE="$DTS_DIR/qcom,ipq5332-jd-be6500.dts"
        
        # ÁîüÊàêËÆæÂ§áÊ†ëÊñá‰ª∂ÔºàÊó†cat EOFÔºâ
        if [ ! -f "$DEVICE_TREE" ]; then
          echo "/dts-v1/;" > "$DEVICE_TREE"
          echo "#include \"qcom,ipq5332.dtsi\"" >> "$DEVICE_TREE"
          echo "#include \"ipq807x.dtsi\"" >> "$DEVICE_TREE"
          echo "" >> "$DEVICE_TREE"
          echo "/ {" >> "$DEVICE_TREE"
          echo "    model = \"JD BE6500\";" >> "$DEVICE_TREE"
          echo "    compatible = \"qcom,ipq5332\", \"qcom,ipq5000\", \"qcom,ipq807x\";" >> "$DEVICE_TREE"
          echo "    /* Ethernet ports */" >> "$DEVICE_TREE"
          echo "    ethernet@a4000000 {" >> "$DEVICE_TREE"
          echo "        compatible = \"qcom,ipq5332-gmac\";" >> "$DEVICE_TREE"
          echo "        reg = <0xa4000000 0x10000>;" >> "$DEVICE_TREE"
          echo "        interrupts = <0 36 4>;" >> "$DEVICE_TREE"
          echo "        qcom,mdio-bus = <&mdio>;" >> "$DEVICE_TREE"
          echo "        qcom,phy-handle = <&ethphy0>;" >> "$DEVICE_TREE"
          echo "    };" >> "$DEVICE_TREE"
          echo "    mdio@a4002000 {" >> "$DEVICE_TREE"
          echo "        compatible = \"qcom,ipq5332-mdio\";" >> "$DEVICE_TREE"
          echo "        reg = <0xa4002000 0x1000>;" >> "$DEVICE_TREE"
          echo "        #address-cells = <1>;" >> "$DEVICE_TREE"
          echo "        #size-cells = <0>;" >> "$DEVICE_TREE"
          echo "        ethphy0: ethernet-phy@0 {" >> "$DEVICE_TREE"
          echo "            reg = <0>;" >> "$DEVICE_TREE"
          echo "        };" >> "$DEVICE_TREE"
          echo "    };" >> "$DEVICE_TREE"
          echo "    /* Ê≠§Â§ÑÂèØÊâ©Â±ïÂÆåÊï¥ËÆæÂ§áÊ†ëÂÜÖÂÆπ */" >> "$DEVICE_TREE"
          echo "};" >> "$DEVICE_TREE"
          echo "‚úÖ ÁîüÊàêËÆæÂ§áÊ†ë: $DEVICE_TREE"
        else
          echo "‚úÖ ËÆæÂ§áÊ†ëÂ∑≤Â≠òÂú®: $DEVICE_TREE"
        fi
        
        # ÂÖ≥ËÅîËÆæÂ§áÊ†ëÂà∞MakefileÔºàÁ∫ØechoÂÆûÁé∞Ôºâ
        MAKEFILE="target/linux/$ARCH/image/Makefile"
        if ! grep -q "jd-be6500" "$MAKEFILE"; then
          echo "‚ùå ËÆæÂ§áÊ†ëÊú™ÂÖ≥ËÅîÔºåÊâãÂä®Ê∑ªÂä†ÂÆö‰πâ..."
          cp "$MAKEFILE" "${MAKEFILE}.bak"  # Â§á‰ªΩÂéüÊñá‰ª∂
          
          # ÈÄêË°åÊ∑ªÂä†ËÆæÂ§áÂÆö‰πâ
          echo 'define Device/jd-be6500' >> "$MAKEFILE"
          echo '  $(Device/ipq807x)' >> "$MAKEFILE"
          echo '  DEVICE_TITLE := JD BE6500 (IPQ5332)' >> "$MAKEFILE"
          echo '  DEVICE_DTS := qcom,ipq5332-jd-be6500' >> "$MAKEFILE"
          echo '  DEVICE_PACKAGES := kmod-ath11k-ct kmod-qca-ppe kmod-qca-nss-drv kmod-qca-nss-gmac kmod-thermal-qcom' >> "$MAKEFILE"
          echo '  IMAGE_SIZE := 256m' >> "$MAKEFILE"
          echo '  IMAGES := sysupgrade.bin factory.bin' >> "$MAKEFILE"
          echo '  IMAGE/sysupgrade.bin := append-kernel | append-rootfs | pad-to \$$(IMAGE_SIZE) | check-size \$$(IMAGE_SIZE)' >> "$MAKEFILE"
          echo '  IMAGE/factory.bin := append-kernel | append-rootfs | pad-to \$$(IMAGE_SIZE) | check-size \$$(IMAGE_SIZE)' >> "$MAKEFILE"
          echo 'endef' >> "$MAKEFILE"
          echo 'TARGET_DEVICES += jd-be6500' >> "$MAKEFILE"
          
          if grep -q "jd-be6500" "$MAKEFILE"; then
            echo "‚úÖ ËÆæÂ§áÊ†ëÂ∑≤ÂÖ≥ËÅîÂà∞Makefile"
          else
            echo "‚ùå ËÆæÂ§áÊ†ëÂÖ≥ËÅîÂ§±Ë¥•ÔºåÈÄÄÂá∫ÊûÑÂª∫"
            exit 1
          fi
        else
          echo "‚úÖ ËÆæÂ§áÊ†ëÂ∑≤ÂÖ≥ËÅîÂà∞Makefile"
        fi

    - name: Â∫îÁî®Ëá™ÂÆö‰πâËÑöÊú¨ÔºàÂÆπÈîôÂ§ÑÁêÜÔºâ
      run: |
        cd $OPENWRT_PATH
        for SCRIPT in $DIY_P1_SH $DIY_P2_SH; do
          if [ -f "$SCRIPT" ]; then
            echo "ÊâßË°åËá™ÂÆö‰πâËÑöÊú¨: $SCRIPT"
            chmod +x "$SCRIPT"
            ./$SCRIPT || echo "‚ö†Ô∏è Ëá™ÂÆö‰πâËÑöÊú¨ $SCRIPT ÊâßË°åÂ§±Ë¥•ÔºåÁªßÁª≠ÊûÑÂª∫"
          else
            echo "‚ùå Êú™ÊâæÂà∞Ëá™ÂÆö‰πâËÑöÊú¨: $SCRIPT"
          fi
        done

    - name: ‰∏ãËΩΩ‰æùËµñÂåÖÔºàÁºìÂ≠ò+Ê†°È™åÔºâ
      run: |
        cd $OPENWRT_PATH
        if [ -d "${{ env.CACHE_DIR }}/dl" ]; then
          echo "‰ΩøÁî®ÁºìÂ≠ò‰æùËµñÂåÖ..."
          cp -rf "${{ env.CACHE_DIR }}/dl" .
        fi
        
        make download -j$(nproc) V=s
        DOWNLOAD_STATUS=$?
        
        mkdir -p "${{ env.CACHE_DIR }}/dl"
        cp -rf dl/* "${{ env.CACHE_DIR }}/dl/"
        find dl -size -1024c -exec rm -f {} \;  # Ê∏ÖÁêÜÁ©∫Êñá‰ª∂
        
        if [ $DOWNLOAD_STATUS -ne 0 ]; then
          echo "‚ö†Ô∏è ‰æùËµñ‰∏ãËΩΩÂºÇÂ∏∏ÔºåÁªßÁª≠ÊûÑÂª∫ÔºàÂèØËÉΩÂΩ±ÂìçÁªìÊûúÔºâ"
          find dl -type f -empty -exec echo "Á©∫Êñá‰ª∂: {}" \;
        else
          echo "‚úÖ ‰æùËµñ‰∏ãËΩΩÂÆåÊàêÔºàÂÖ± $(find dl -type f | wc -l) ‰∏™Êñá‰ª∂Ôºâ"
        fi

    - name: ÁºñËØëÂõ∫‰ª∂ÔºàÂèåÈò∂ÊÆµ+ËØ¶ÁªÜÊó•ÂøóÔºâ
      run: |
        cd $OPENWRT_PATH
        JOBS=$(nproc)
        [ $JOBS -gt 4 ] && JOBS=4  # ÈôêÂà∂Á∫øÁ®ãÊï∞
        
        # Èò∂ÊÆµ1ÔºöÂπ∂Ë°åÁºñËØë
        echo "ÂºÄÂßãÂπ∂Ë°åÁºñËØëÔºà-j$JOBSÔºâ..."
        make -j$JOBS V=s 2>&1 | tee compile_phase1.log
        PHASE1_STATUS=$?
        
        if [ $PHASE1_STATUS -ne 0 ]; then
          echo "‚ùå Âπ∂Ë°åÁºñËØëÂ§±Ë¥•ÔºåÂàáÊç¢ÂçïÁ∫øÁ®ãÈáçËØï..."
          make -j1 V=s 2>&1 | tee compile_phase2.log
          PHASE2_STATUS=$?
          
          if [ $PHASE2_STATUS -ne 0 ]; then
            echo "üí• ÁºñËØëÂ§±Ë¥•ÔºåÊî∂ÈõÜÈîôËØØÊó•Âøó..."
            mkdir -p error_logs
            cp compile_phase*.log error_logs/
            cp $(find . -name "*.err" -or -name "*.log" -or -name "*.rej") error_logs/ 2>/dev/null
            cp .config error_logs/
            cp target/linux/ipq807x/image/Makefile error_logs/
            tar -czf error_logs.tar.gz error_logs
            exit 1
          else
            echo "‚úÖ ÂçïÁ∫øÁ®ãÁºñËØëÊàêÂäü"
          fi
        else
          echo "‚úÖ Âπ∂Ë°åÁºñËØëÊàêÂäü"
        fi

    - name: ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÂº∫Âà∂ËÆæÁΩÆËÆæÂ§áÂÆö‰πâ
      run: |
        cd $OPENWRT_PATH
        MAKEFILE="target/linux/$ARCH/image/Makefile"
        
        # Á°Æ‰øùËÆæÂ§áÂÆö‰πâÂ≠òÂú®
        if ! grep -q "define Device/jd-be6500" "$MAKEFILE"; then
          echo "‚ùå Êú™ÊâæÂà∞ËÆæÂ§áÂÆö‰πâÔºåÊ∑ªÂä†Ê≠£Á°ÆÈÖçÁΩÆ..."
          
          # Â§á‰ªΩÂéüÊñá‰ª∂
          cp "$MAKEFILE" "${MAKEFILE}.bak"
          
          # Ê∑ªÂä†ËÆæÂ§áÂÆö‰πâÔºàÁªßÊâøËá™ipq807xÔºâ
          echo 'define Device/jd-be6500' >> "$MAKEFILE"
          echo '  $(Device/ipq807x)' >> "$MAKEFILE"
          echo '  DEVICE_TITLE := JD BE6500 (IPQ5332)' >> "$MAKEFILE"
          echo '  DEVICE_DTS := qcom,ipq5332-jd-be6500' >> "$MAKEFILE"
          echo '  DEVICE_PACKAGES := kmod-ath11k-ct kmod-qca-ppe kmod-qca-nss-drv kmod-qca-nss-gmac kmod-thermal-qcom' >> "$MAKEFILE"
          echo '  IMAGE_SIZE := 256m' >> "$MAKEFILE"
          echo '  IMAGES := sysupgrade.bin factory.bin' >> "$MAKEFILE"
          echo '  IMAGE/sysupgrade.bin := append-kernel | append-rootfs | pad-to \$$(IMAGE_SIZE) | check-size \$$(IMAGE_SIZE)' >> "$MAKEFILE"
          echo '  IMAGE/factory.bin := append-kernel | append-rootfs | pad-to \$$(IMAGE_SIZE) | check-size \$$(IMAGE_SIZE)' >> "$MAKEFILE"
          echo 'endef' >> "$MAKEFILE"
          echo 'TARGET_DEVICES += jd-be6500' >> "$MAKEFILE"
          
          echo "‚úÖ ËÆæÂ§áÂÆö‰πâÂ∑≤Êõ¥Êñ∞"
        else
          # ‰øÆÂ§çÂèØËÉΩÁöÑÈáçÂ§çgenericÂÆö‰πâ
          echo "‰øÆÂ§çËÆæÂ§áÂÆö‰πâ‰∏≠ÁöÑÈáçÂ§çgeneric..."
          sed -i '/define Device\/jd-be6500/a \  DEVICE_NAME := jd-be6500' "$MAKEFILE"
          sed -i '/define Device\/jd-be6500/a \  DEVICE_PROFILE := jd-be6500' "$MAKEFILE"
          sed -i '/define Device\/jd-be6500/a \  DEVICE_FILESYSTEMS := squashfs ext4' "$MAKEFILE"
          
          # Á°Æ‰øùDEVICE_PACKAGESÊ≠£Á°Æ
          sed -i 's/^ \+DEVICE_PACKAGES.*/  DEVICE_PACKAGES := kmod-ath11k-ct kmod-qca-ppe kmod-qca-nss-drv kmod-qca-nss-gmac kmod-thermal-qcom/' "$MAKEFILE"
          
          echo "‚úÖ ËÆæÂ§áÂÆö‰πâÂ∑≤‰ºòÂåñ"
        fi

    - name: Ê∏ÖÁêÜ.config‰∏≠ÁöÑÂÜó‰ΩôËÆæÁΩÆ
      run: |
        cd $OPENWRT_PATH
        CONFIG_FILE=".config"
        
        # Â§á‰ªΩÂéüÈÖçÁΩÆ
        cp "$CONFIG_FILE" "${CONFIG_FILE}.bak"
        
        # ÁßªÈô§ÈáçÂ§çÁöÑTARGET_GENERICËÆæÁΩÆ
        sed -i '/CONFIG_TARGET_GENERIC/d' "$CONFIG_FILE"
        
        # Á°Æ‰øùÊ≠£Á°ÆÁöÑËÆæÂ§áËÆæÁΩÆ
        sed -i '/CONFIG_TARGET_IPQ807X/d' "$CONFIG_FILE"
        sed -i '/CONFIG_TARGET_IPQ807X_DEVICE_jd-be6500/d' "$CONFIG_FILE"
        
        echo "CONFIG_TARGET_IPQ807X=y" >> "$CONFIG_FILE"
        echo "CONFIG_TARGET_IPQ807X_DEVICE_jd-be6500=y" >> "$CONFIG_FILE"
        
        # ÁßªÈô§ÂèØËÉΩÂØºËá¥ÈáçÂ§çÂëΩÂêçÁöÑËÆæÁΩÆ
        sed -i '/CONFIG_TARGET_IMAGES_PAD/d' "$CONFIG_FILE"
        sed -i '/CONFIG_TARGET_ROOTFS_PARTSIZE/d' "$CONFIG_FILE"
        
        # Á°Æ‰øùÂøÖË¶ÅÁöÑÁºñËØëÈÄâÈ°π
        echo "CONFIG_ALL_KMODS=y" >> "$CONFIG_FILE"
        echo "CONFIG_DEVEL=y" >> "$CONFIG_FILE"
        
        echo "‚úÖ .configÂ∑≤‰ºòÂåñ"

    - name: Êô∫ËÉΩÂõ∫‰ª∂Ë∑ØÂæÑÊ£ÄÊµãÔºàÂ§öË∑ØÂæÑÈÄÇÈÖç+Ê®°Á≥äÂåπÈÖçÔºâ
      id: firmware_path
      run: |
        cd $OPENWRT_PATH
        
        # ‰ºòÂÖàÊ£ÄÊü•Ê†áÂáÜÂõ∫‰ª∂ÁîüÊàêË∑ØÂæÑ
        FIRMWARE_PATHS=(
          "bin/targets/ipq807x/generic"  # Ê†áÂáÜÂõ∫‰ª∂Ë∑ØÂæÑ
          "bin/targets/ipq807x/jd-be6500"  # Êñ∞Â¢ûÁâπÂÆöËÆæÂ§áË∑ØÂæÑ
          "bin/targets/qcom/ipq5332"
          "bin"
        )
        
        # Êü•ÊâæÂ≠òÂú®ÁöÑË∑ØÂæÑ
        FOUND_PATH=""
        for path in "${FIRMWARE_PATHS[@]}"; do
          if [ -d "$path" ]; then
            FOUND_PATH="$path"
            echo "‚úÖ ÊâæÂà∞Âõ∫‰ª∂ÁõÆÂΩï: $path"
            break
          fi
        done
        
        # È™åËØÅË∑ØÂæÑ
        if [ -z "$FOUND_PATH" ]; then
          echo "‚ùå Êú™ÊâæÂà∞‰ªª‰ΩïÂõ∫‰ª∂ÁõÆÂΩïÔºåÂèØÁî®Ë∑ØÂæÑ:"
          find . -type d -name "bin" -o -name "ipq807x" -o -name "qcom" -o -name "generic"
          exit 1
        fi
        
        # ‰øùÂ≠òË∑ØÂæÑÂà∞ÁéØÂ¢ÉÂèòÈáè
        echo "FIRMWARE_PATH=$FOUND_PATH" >> $GITHUB_ENV
        echo "firmware_path=$FOUND_PATH" >> $GITHUB_OUTPUT
        
        # ‰ºòÂåñÂõ∫‰ª∂Êñá‰ª∂ÂåπÈÖçÊ®°ÂºèÔºàÊõ¥ÈÄöÁî®ÁöÑÂåπÈÖçÔºâ
        echo "Ê£ÄÊü•Âõ∫‰ª∂Êñá‰ª∂..."
        FIRMWARE_PATTERNS=(
          "jd-be6500-squashfs-sysupgrade.bin"  # Á≤æÁ°ÆÂåπÈÖç
          "jd-be6500-factory.bin"
          "ipq5332-jd-be6500-squashfs-sysupgrade.bin"
          "ipq807x-jd-be6500-squashfs-sysupgrade.bin"
          "*squashfs-sysupgrade.bin"
          "*factory.bin"
        )
        
        # Êåâ‰ºòÂÖàÁ∫ßÊü•ÊâæÂåπÈÖçÁöÑÊñá‰ª∂
        FOUND=false
        for pattern in "${FIRMWARE_PATTERNS[@]}"; do
          MATCHING_FILES=($(ls $FOUND_PATH/$pattern 2>/dev/null))
          if [ ${#MATCHING_FILES[@]} -gt 0 ]; then
            FIRMWARE_NAME=${MATCHING_FILES[0]}
            FIRMWARE_FULL_PATH="$FOUND_PATH/${MATCHING_FILES[0]}"
            
            echo "‚úÖ ÊâæÂà∞ÂåπÈÖçÁöÑÂõ∫‰ª∂Êñá‰ª∂: $FIRMWARE_NAME"
            echo "Âõ∫‰ª∂ÂêçÁß∞: $FIRMWARE_NAME"
            echo "Âõ∫‰ª∂Ë∑ØÂæÑ: $FIRMWARE_FULL_PATH"
            
            # ‰øùÂ≠òÂà∞ÁéØÂ¢ÉÂèòÈáè
            echo "FIRMWARE_NAME=$FIRMWARE_NAME" >> $GITHUB_ENV
            echo "FIRMWARE_FULL_PATH=$FIRMWARE_FULL_PATH" >> $GITHUB_ENV
            echo "firmware_name=$FIRMWARE_NAME" >> $GITHUB_OUTPUT
            echo "firmware_full_path=$FIRMWARE_FULL_PATH" >> $GITHUB_OUTPUT
            
            FOUND=true
            break
          fi
        done
        
        if [ "$FOUND" = false ]; then
          echo "‚ùå Êú™ÊâæÂà∞‰ªª‰ΩïÂåπÈÖçÁöÑÂõ∫‰ª∂Êñá‰ª∂ÔºåÂèØÁî®Êñá‰ª∂:"
          ls -lh $FOUND_PATH/*.bin || true
          exit 1
        fi

    - name: È™åËØÅÂõ∫‰ª∂Â≠òÂú®
      run: |
        cd $OPENWRT_PATH
        
        # ‰ΩøÁî®‰øùÂ≠òÁöÑÂèòÈáèÈ™åËØÅÂõ∫‰ª∂
        if [ -f "${{ env.FIRMWARE_FULL_PATH }}" ]; then
          echo "‚úÖ Âõ∫‰ª∂Â≠òÂú®: ${{ env.FIRMWARE_FULL_PATH }}"
          echo "Âõ∫‰ª∂Â§ßÂ∞è: $(du -h ${{ env.FIRMWARE_FULL_PATH }} | cut -f1)"
          echo "Âõ∫‰ª∂SHA256Ê†°È™åÂíå: $(sha256sum ${{ env.FIRMWARE_FULL_PATH }} | cut -d' ' -f1)"
        else
          echo "‚ùå Âõ∫‰ª∂‰∏çÂ≠òÂú®: ${{ env.FIRMWARE_FULL_PATH }}"
          echo "ÂèØÁî®Êñá‰ª∂:"
          ls -lh ${{ env.FIRMWARE_PATH }}/*.bin || true
          exit 1
        fi

    - name: ÊòæÁ§∫ÁõÆÂΩïÁªìÊûÑÔºàË∞ÉËØïÁî®Ôºâ
      run: |
        cd $OPENWRT_PATH
        echo "=== ÁõÆÂΩïÁªìÊûÑ ==="
        find . -type d -name "target" -o -name "bin" -o -name "ipq807x" -o -name "ipq5332" -o -name "qcom" -o -name "generic"
        
        echo "=== Âõ∫‰ª∂Êñá‰ª∂ÂàóË°® ==="
        find . -name "*.bin" -o -name "*.img" -o -name "*.tar.gz"

    - name: ÁîüÊàêÁâàÊú¨‰ø°ÊÅØ
      id: version
      run: |
        cd $OPENWRT_PATH
        RELEASE_DATE=$(date +%Y%m%d)
        COMMIT_ID=$(git rev-parse --short HEAD)
        echo "release_version=OpenWrt_${RELEASE_DATE}_${COMMIT_ID}" >> $GITHUB_ENV
        echo "release_version=OpenWrt_${RELEASE_DATE}_${COMMIT_ID}" >> $GITHUB_OUTPUT
        
        cat <<EOF > version.info
        OpenWrt Âõ∫‰ª∂ for JD BE6500 (IPQ5332)
        ÁºñËØëÊó∂Èó¥: $(date +"%Y-%m-%d %H:%M:%S")
        Git Êèê‰∫§: $COMMIT_ID
        ÂàÜÊîØ: $LIENOL_BRANCH
        ÁõÆÊ†áÂπ≥Âè∞: $ARCH/$SUBARCH
        Âõ∫‰ª∂ÂêçÁß∞: ${{ env.FIRMWARE_NAME }}
        Âõ∫‰ª∂ÂÆåÊï¥Ë∑ØÂæÑ: ${{ env.FIRMWARE_FULL_PATH }}
        Âõ∫‰ª∂Â§ßÂ∞è: $(du -h ${{ env.FIRMWARE_FULL_PATH }} | cut -f1)
        Âõ∫‰ª∂SHA256Ê†°È™åÂíå: $(sha256sum ${{ env.FIRMWARE_FULL_PATH }} | cut -d' ' -f1)
        EOF

    - name: ‰∏ä‰º†Âõ∫‰ª∂Âà∞Artifact
      if: env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.release_version }}
        path: |
          ${{ env.FIRMWARE_FULL_PATH }}
          ${{ env.FIRMWARE_PATH }}/*.img
          ${{ env.FIRMWARE_PATH }}/*.tar.gz
          ${{ env.FIRMWARE_PATH }}/sha256sums
          version.info
        retention-days: 30
        if-no-files-found: error
      env:
        FIRMWARE_PATH: ${{ env.FIRMWARE_PATH }}
        FIRMWARE_NAME: ${{ env.FIRMWARE_NAME }}
        FIRMWARE_FULL_PATH: ${{ env.FIRMWARE_FULL_PATH }}

    - name: ÂèëÂ∏ÉÂà∞GitHub Release
      if: env.UPLOAD_RELEASE == 'true' && github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ env.release_version }}
        tag_name: ${{ env.release_version }}
        body_path: version.info
        files: |
          ${{ env.FIRMWARE_FULL_PATH }}
          ${{ env.FIRMWARE_PATH }}/sha256sums
          version.info
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.MY_TOKEN }}
        FIRMWARE_PATH: ${{ env.FIRMWARE_PATH }}
        FIRMWARE_NAME: ${{ env.FIRMWARE_NAME }}
        FIRMWARE_FULL_PATH: ${{ env.FIRMWARE_FULL_PATH }}
