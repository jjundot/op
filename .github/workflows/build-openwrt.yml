name: Build OpenWrt for JD BE6500

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  release:
    types: published  # å‘å¸ƒReleaseæ—¶è§¦å‘

env:
  LIENOL_REPO: https://github.com/Lienol/openwrt          # Lienolä¸»ä»“åº“URL
  LIENOL_TARGET_REPO: https://github.com/Lienol/openwrt-target-ipq807x  # IPQ807xç›®æ ‡ä»“åº“
  LIENOL_BRANCH: 23.05                                  # Lienolé»˜è®¤åˆ†æ”¯
  ARCH: ipq807x                                          # ç›®æ ‡æ¶æ„
  SUBARCH: generic                                       # å­æ¶æ„
  CPU_ARCH: aarch64_cortex-a53                           # CPUæ¶æ„
  FEEDS_CONF: feeds.conf.default                         # Feedsé…ç½®æ–‡ä»¶
  CONFIG_FILE: .config                                   # ç¼–è¯‘é…ç½®æ–‡ä»¶
  DIY_P1_SH: diy-part1.sh                                # è‡ªå®šä¹‰è„šæœ¬1
  DIY_P2_SH: diy-part2.sh                                # è‡ªå®šä¹‰è„šæœ¬2
  UPLOAD_BIN_DIR: false                                  # ä¸ä¸Šä¼ binç›®å½•
  UPLOAD_FIRMWARE: true                                  # ä¸Šä¼ å›ºä»¶
  UPLOAD_RELEASE: true                                   # å‘å¸ƒåˆ°Release
  TZ: Asia/Shanghai                                      # æ—¶åŒº
  GITHUB_TOKEN: ${{ secrets.MY_TOKEN }}                  # è‡ªå®šä¹‰Tokenåç§°

jobs:
  build:
    runs-on: ubuntu-22.04                                 # è¿è¡Œç¯å¢ƒ

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        path: scripts                                      # è‡ªå®šä¹‰æ£€å‡ºè·¯å¾„

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'                             # Pythonç‰ˆæœ¬

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get -y install build-essential subversion git-core libncurses5-dev zlib1g-dev gawk flex quilt libssl-dev xsltproc libxml-parser-perl mercurial bzr ecj cvs unzip python3-distutils file wget
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android/sdk

    - name: Configure Git Credentials
      run: |
        # é…ç½®Gitå‡­æ®å­˜å‚¨ï¼Œè§£å†³URLæ³¨å…¥é—®é¢˜
        git config --global credential.helper store
        echo "https://${GITHUB_TOKEN}:@github.com" > ~/.git-credentials
        # éªŒè¯é…ç½®
        echo "Git credential helper: $(git config --global --get credential.helper)"
        echo "Stored credentials: $(cat ~/.git-credentials || echo 'No credentials stored')"

    - name: Clone Lienol's OpenWrt repo
      run: |
        # æ¸…ç†æ—§ç›®å½•
        rm -rf openwrt
        
        # æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨
        echo "Checking if branch $LIENOL_BRANCH exists..."
        if ! git ls-remote --heads $LIENOL_REPO $LIENOL_BRANCH | grep -q $LIENOL_BRANCH; then
          echo "Branch $LIENOL_BRANCH does not exist in $LIENOL_REPO"
          echo "Available branches:"
          git ls-remote --heads $LIENOL_REPO | awk '{print $2}'
          exit 1
        fi
        
        # å…‹éš†ä»“åº“
        for i in {1..3}; do
          echo "Attempt $i/3 to clone Lienol's OpenWrt repo..."
          git clone --depth=1 $LIENOL_REPO -b $LIENOL_BRANCH openwrt
          if [ $? -eq 0 ]; then
            echo "âœ… ä»“åº“å…‹éš†æˆåŠŸ"
            break
          fi
          echo "âŒ å…‹éš†å¤±è´¥ï¼Œ10ç§’åé‡è¯•..."
          sleep 10
        done
        
        # éªŒè¯å…‹éš†ç»“æœ
        if [ ! -d "openwrt" ]; then
          echo "ğŸ’¥ ä¸‰æ¬¡å…‹éš†å‡å¤±è´¥ï¼Œé€€å‡ºæ„å»º"
          exit 1
        fi
        
        cd openwrt
        echo "OPENWRT_PATH=$(pwd)" >> $GITHUB_ENV

    - name: Prepare IPQ5322 device tree
      run: |
        cd $OPENWRT_PATH
        
        # ä»ä¸»ä»“åº“ç¨€ç–å…‹éš†IPQ807xç›®æ ‡æ”¯æŒ
        if [ ! -d "target/linux/$ARCH" ]; then
          echo "Cloning IPQ807x target support from main repo using sparse checkout..."
          for i in {1..3}; do
            git clone --depth=1 $LIENOL_REPO -b $LIENOL_BRANCH --single-branch --no-checkout temp_repo
            if [ $? -ne 0 ]; then
              echo "âŒ å…‹éš†ä¸»ä»“åº“å¤±è´¥ï¼Œé‡è¯•ä¸­..."
              rm -rf temp_repo
              sleep 10
              continue
            fi
            
            cd temp_repo
            git sparse-checkout init --cone
            git sparse-checkout set "target/linux/$ARCH"
            git checkout
            if [ $? -ne 0 ]; then
              echo "âŒ ç¨€ç–æ£€å‡ºå¤±è´¥ï¼Œé‡è¯•ä¸­..."
              cd ..
              rm -rf temp_repo
              sleep 10
              continue
            fi
            
            mv target/linux/$ARCH ../target/linux/
            cd ..
            rm -rf temp_repo
            
            if [ -d "target/linux/$ARCH" ]; then
              echo "âœ… IPQ807x target support cloned successfully"
              break
            fi
            
            echo "âŒ å…‹éš†å¤±è´¥ï¼Œ10ç§’åé‡è¯•..."
            sleep 10
          done
          
          if [ ! -d "target/linux/$ARCH" ]; then
            echo "ğŸ’¥ æ— æ³•è·å–IPQ807xç›®æ ‡æ”¯æŒï¼Œé€€å‡ºæ„å»º"
            exit 1
          fi
        fi
        
        # åˆ›å»ºè®¾å¤‡æ ‘ï¼ˆæ”¹ç”¨sedï¼Œç¡®ä¿æ ¼å¼æ­£ç¡®ï¼‰
        DEVICE_TREE="qcom,ipq5322-jd-be6500.dts"
        DTS_DIR="target/linux/$ARCH/dts"
        mkdir -p "$DTS_DIR"
        if [ ! -f "$DTS_DIR/$DEVICE_TREE" ]; then
          echo "ç”ŸæˆJD BE6500è®¾å¤‡æ ‘..."
          sed -e 's/^  //' > "$DTS_DIR/$DEVICE_TREE" << 'END_OF_DTS'
            /dts-v1/;
            #include "qcom,ipq5322.dtsi"

            / {
              model = "JD BE6500";
              compatible = "qcom,ipq5322", "qcom,ipq5000";

              chosen {
                bootargs = "earlycon=msm_serial_dm,0x1a10000 console=ttyMSM0,115200n8";
              };

              memory@80000000 {
                device_type = "memory";
                reg = <0x80000000 0x40000000>; /* 1GB */
              };
            };
          END_OF_DTS
          
          # éªŒè¯è®¾å¤‡æ ‘è¯­æ³•
          if command -v dtc &>/dev/null; then
            dtc -I dts -O dtb -o /dev/null "$DTS_DIR/$DEVICE_TREE"
            if [ $? -ne 0 ]; then
              echo "âŒ è®¾å¤‡æ ‘è¯­æ³•é”™è¯¯"
              cat "$DTS_DIR/$DEVICE_TREE"
              exit 1
            else
              echo "âœ… è®¾å¤‡æ ‘è¯­æ³•éªŒè¯é€šè¿‡"
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ°dtcå·¥å…·ï¼Œè·³è¿‡è®¾å¤‡æ ‘è¯­æ³•éªŒè¯"
          fi
        fi
        
        # ç”Ÿæˆfeeds.conf.defaultï¼ˆæ”¹ç”¨sedï¼‰
        if [ ! -f "feeds.conf.default" ]; then
          echo "ç”Ÿæˆfeedsé…ç½®æ–‡ä»¶..."
          sed -e 's/^  //' > feeds.conf.default << 'END_OF_FEEDS'
            src-gz openwrt_core https://openwrt.lienz.net/snapshots/targets/ipq807x/generic/packages
            src-gz openwrt_base https://openwrt.lienz.net/snapshots/packages/aarch64_cortex-a53/base
            src-gz openwrt_luci https://openwrt.lienz.net/snapshots/packages/aarch64_cortex-a53/luci
            src-gz openwrt_packages https://openwrt.lienz.net/snapshots/packages/aarch64_cortex-a53/packages
            src-git lienol https://github.com/Lienol/openwrt-package
          END_OF_FEEDS
        fi
        
        # æ›´æ–°Feedsï¼ˆå¸¦è¯¦ç»†æ—¥å¿—ï¼‰
        echo "å¼€å§‹æ›´æ–°feeds..."
        rm -rf feeds/*
        for i in {1..5}; do
          echo "å°è¯• $i/5 æ›´æ–°feeds..."
          ./scripts/feeds update -a 2>&1 | tee feeds_update.log
          if [ $? -eq 0 ]; then
            echo "âœ… Feedsæ›´æ–°æˆåŠŸï¼Œå¼€å§‹å®‰è£…..."
            ./scripts/feeds install -a 2>&1 | tee feeds_install.log
            if [ $? -eq 0 ]; then
              PACKAGE_COUNT=$(./scripts/feeds list | grep -vE '^#|^$' | wc -l)
              echo "âœ… æ‰¾åˆ° $PACKAGE_COUNT ä¸ªè½¯ä»¶åŒ…"
              # å†™å…¥ç›®æ ‡é…ç½®
              echo "CONFIG_TARGET_ipq807x=y" >> .config
              echo "CONFIG_TARGET_ipq807x_generic=y" >> .config
              echo "CONFIG_TARGET_IPQ807X_DEVICE_jd-be6500=y" >> .config
              break
            else
              echo "âŒ Feedså®‰è£…å¤±è´¥ï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š"
              cat feeds_install.log
            fi
          else
            echo "âŒ Feedsæ›´æ–°å¤±è´¥ï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š"
            cat feeds_update.log
          fi
          
          echo "æ¸…ç†å¹¶å°è¯•é‡æ–°æ›´æ–°..."
          rm -rf feeds/*
          sleep 15
        done
        
        # æ£€æŸ¥Feedsæ›´æ–°ç»“æœ
        if [ ! -d "feeds" ]; then
          echo "ğŸ’¥ Feedsæ›´æ–°å¤±è´¥ï¼Œé€€å‡ºæ„å»º"
          cat feeds_update.log
          exit 1
        fi

    - name: Customize feeds (Part 1)
      run: |
        if [ -f "$GITHUB_WORKSPACE/scripts/$DIY_P1_SH" ]; then
          cd $OPENWRT_PATH
          chmod +x $GITHUB_WORKSPACE/scripts/$DIY_P1_SH
          echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ $DIY_P1_SH..."
          $GITHUB_WORKSPACE/scripts/$DIY_P1_SH
        else
          echo "âš ï¸ æœªæ‰¾åˆ°è‡ªå®šä¹‰è„šæœ¬ $DIY_P1_SHï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
        fi

    - name: Load custom configuration
      run: |
        cd $OPENWRT_PATH
        if [ -f "$GITHUB_WORKSPACE/scripts/$CONFIG_FILE" ]; then
          cp $GITHUB_WORKSPACE/scripts/$CONFIG_FILE .config
          echo "âœ… å·²åŠ è½½è‡ªå®šä¹‰é…ç½®"
          cat .config | grep -v '^#' | grep -v '^$' | wc -l > config_count.txt
          echo "é…ç½®é¡¹æ•°é‡: $(cat config_count.txt)"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°è‡ªå®šä¹‰é…ç½®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
          make defconfig
        fi

    - name: Customize configuration (Part 2)
      run: |
        if [ -f "$GITHUB_WORKSPACE/scripts/$DIY_P2_SH" ]; then
          cd $OPENWRT_PATH
          chmod +x $GITHUB_WORKSPACE/scripts/$DIY_P2_SH
          echo "æ‰§è¡Œè‡ªå®šä¹‰é…ç½®è„šæœ¬ $DIY_P2_SH..."
          $GITHUB_WORKSPACE/scripts/$DIY_P2_SH
        else
          echo "âš ï¸ æœªæ‰¾åˆ°è‡ªå®šä¹‰è„šæœ¬ $DIY_P2_SH"
        fi

    - name: Download package dependencies
      run: |
        cd $OPENWRT_PATH
        echo "å¼€å§‹ä¸‹è½½åŒ…ä¾èµ–..."
        make download -j$(nproc) V=s
        DOWNLOAD_STATUS=$?
        
        # æ¸…ç†æ— æ•ˆä¸‹è½½
        echo "æ¸…ç†æ— æ•ˆä¸‹è½½æ–‡ä»¶..."
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
        
        # æ£€æŸ¥ä¸‹è½½çŠ¶æ€
        if [ $DOWNLOAD_STATUS -ne 0 ]; then
          echo "âš ï¸ ä¸‹è½½è¿‡ç¨‹ä¸­å¯èƒ½å­˜åœ¨é”™è¯¯ï¼Œä½†ç»§ç»­æ„å»º..."
        else
          echo "âœ… åŒ…ä¾èµ–ä¸‹è½½å®Œæˆ"
        fi

    - name: Build firmware
      run: |
        cd $OPENWRT_PATH
        echo "å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        echo "ä½¿ç”¨ $(nproc) çº¿ç¨‹ç¼–è¯‘..."
        
        # å°è¯•å¹¶è¡Œç¼–è¯‘ï¼Œå¤±è´¥åˆ™å•çº¿ç¨‹é‡è¯•
        make -j$(nproc) V=s || make -j1 V=s
        
        BUILD_STATUS=$?
        if [ $BUILD_STATUS -ne 0 ]; then
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          
          # æ”¶é›†é”™è¯¯æ—¥å¿—
          echo "æ”¶é›†ç¼–è¯‘é”™è¯¯æ—¥å¿—..."
          mkdir -p error_logs
          find . -name "*.log" -exec cp {} error_logs/ \;
          tar -czf error_logs.tar.gz error_logs
          
          exit $BUILD_STATUS
        else
          echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ"
        fi

    - name: Check space usage
      run: |
        echo "æ£€æŸ¥ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ:"
        df -h
        echo "OpenWrt binç›®å½•å¤§å°:"
        du -sh $OPENWRT_PATH/bin

    - name: Collect firmware files
      id: collect
      run: |
        cd $OPENWRT_PATH/bin/targets/*/*
        FIRMWARE_PATH=$(pwd)
        echo "FIRMWARE_PATH=$FIRMWARE_PATH" >> $GITHUB_ENV
        echo "::set-output name=status::success"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å›ºä»¶æ–‡ä»¶
        if [ -n "$(ls $FIRMWARE_PATH/*.bin 2>/dev/null)" ]; then
          echo "FILES_AVAILABLE=true" >> $GITHUB_ENV
          echo "âœ… æ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          
          # åˆ—å‡ºæ‰€æœ‰å›ºä»¶æ–‡ä»¶
          echo "å›ºä»¶æ–‡ä»¶åˆ—è¡¨:"
          ls -lh $FIRMWARE_PATH/*.bin
        else
          echo "FILES_AVAILABLE=false" >> $GITHUB_ENV
          echo "âŒ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          
          # æ”¶é›†å¯ç”¨æ–‡ä»¶
          echo "å¯ç”¨æ–‡ä»¶åˆ—è¡¨:"
          ls -lh $FIRMWARE_PATH/* || true
        fi

    - name: Upload firmware as artifact
      if: steps.collect.outputs.status == 'success' && env.FILES_AVAILABLE == 'true' && env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-Firmware-${{ github.sha }}
        path: ${{ env.FIRMWARE_PATH }}/*
        retention-days: 30
        if-no-files-found: error

    - name: Upload firmware to Release
      if: steps.collect.outputs.status == 'success' && env.FILES_AVAILABLE == 'true' && env.UPLOAD_RELEASE == 'true' && github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.FIRMWARE_PATH }}/*
        tag_name: ${{ github.ref_name }}
        body: |
          OpenWrt firmware for JD BE6500
          Built from commit ${{ github.sha }}
          Date: $(date +%Y-%m-%d)
      env:
        GITHUB_TOKEN: ${{ secrets.MY_TOKEN }}    
