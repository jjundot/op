name: Build OpenWrt for JD BE6500 (IPQ5332)

on:
  workflow_dispatch:  # ÊâãÂä®Ëß¶Âèë
  release:
    types: published  # ÂèëÂ∏ÉReleaseÊó∂Ëß¶Âèë

env:
  LIENOL_REPO: https://github.com/Lienol/openwrt          # Lienol‰∏ª‰ªìÂ∫ì
  LIENOL_BRANCH: 23.05                                  # ‰ΩøÁî®23.05ÂàÜÊîØ
  ARCH: ipq807x                                          # ‰ΩøÁî®ipq807xÁõÆÊ†áÔºàÂÖºÂÆπIPQ5332Ôºâ
  SUBARCH: generic                                       # ÈÄöÁî®Â≠êÊû∂ÊûÑ
  CPU_ARCH: aarch64_cortex-a53                           # CPUÊû∂ÊûÑ
  FEEDS_CONF: feeds.conf.default                         # FeedsÈÖçÁΩÆÊñá‰ª∂
  CONFIG_FILE: .config                                   # ÁºñËØëÈÖçÁΩÆÊñá‰ª∂
  DIY_P1_SH: diy-part1.sh                                # Ëá™ÂÆö‰πâËÑöÊú¨1
  DIY_P2_SH: diy-part2.sh                                # Ëá™ÂÆö‰πâËÑöÊú¨2
  UPLOAD_BIN_DIR: false                                  # ‰∏ç‰∏ä‰º†binÁõÆÂΩï
  UPLOAD_FIRMWARE: true                                  # ‰∏ä‰º†Âõ∫‰ª∂
  UPLOAD_RELEASE: true                                   # ÂèëÂ∏ÉÂà∞Release
  TZ: Asia/Shanghai                                      # Êó∂Âå∫
  GITHUB_TOKEN: ${{ secrets.MY_TOKEN }}                  # GitHub Token

jobs:
  build:
    runs-on: ubuntu-22.04                                 # ËøêË°åÁéØÂ¢É

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        path: scripts                                      # Ê£ÄÂá∫Ë∑ØÂæÑ

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'                             # PythonÁâàÊú¨

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get -y install build-essential subversion git-core libncurses5-dev zlib1g-dev gawk flex quilt libssl-dev xsltproc libxml-parser-perl mercurial bzr ecj cvs unzip python3-distutils file wget upx-ucl
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android/sdk

    - name: Configure Git Credentials
      run: |
        git config --global credential.helper store
        echo "https://${GITHUB_TOKEN}:@github.com" > ~/.git-credentials
        echo "Git credential helper: $(git config --global --get credential.helper)"
        echo "Stored credentials: $(cat ~/.git-credentials || echo 'No credentials stored')"

    - name: Clone Lienol's OpenWrt repo
      run: |
        rm -rf openwrt
        
        # Ê£ÄÊü•ÂàÜÊîØÊúâÊïàÊÄß
        echo "Checking branch $LIENOL_BRANCH..."
        if ! git ls-remote --heads $LIENOL_REPO $LIENOL_BRANCH | grep -q $LIENOL_BRANCH; then
          echo "Branch not found. Available branches:"
          git ls-remote --heads $LIENOL_REPO | awk '{print $2}'
          exit 1
        fi
        
        # ‰∏âÊ¨°ÂÖãÈöÜÈáçËØï
        for i in {1..3}; do
          echo "Attempt $i/3 to clone repo..."
          git clone --depth=1 $LIENOL_REPO -b $LIENOL_BRANCH openwrt
          if [ $? -eq 0 ]; then
            echo "‚úÖ ‰ªìÂ∫ìÂÖãÈöÜÊàêÂäü"
            break
          fi
          echo "‚ùå ÂÖãÈöÜÂ§±Ë¥•Ôºå10ÁßíÂêéÈáçËØï..."
          sleep 10
        done
        
        if [ ! -d "openwrt" ]; then
          echo "üí• ‰∏âÊ¨°ÂÖãÈöÜÂ§±Ë¥•ÔºåÈÄÄÂá∫"
          exit 1
        fi
        
        cd openwrt
        echo "OPENWRT_PATH=$(pwd)" >> $GITHUB_ENV

    - name: Prepare IPQ5332 device tree
      run: |
        cd $OPENWRT_PATH
        
        # ÂàõÂª∫ËÆæÂ§áÊ†ëÔºàIPQ5332Âú®IPQ807xÁõÆÊ†á‰∏ãÁöÑÈÄÇÈÖçÔºâ
        DEVICE_TREE="qcom,ipq5332-jd-be6500.dts"
        DTS_DIR="target/linux/$ARCH/dts"
        mkdir -p "$DTS_DIR"
        
        if [ ! -f "$DTS_DIR/$DEVICE_TREE" ]; then
          echo "ÁîüÊàêJD BE6500ËÆæÂ§áÊ†ë..."
          > "$DTS_DIR/$DEVICE_TREE"
          
          # ËÆæÂ§áÊ†ëÂÜÖÂÆπÔºàÂÖ≥ÈîÆ‰øÆÊîπÔºöÂÖºÂÆπipq807xÁõÆÊ†áÔºâ
          echo "/dts-v1/;" >> "$DTS_DIR/$DEVICE_TREE"
          echo "#include \"qcom,ipq5332.dtsi\"" >> "$DTS_DIR/$DEVICE_TREE"
          echo "#include \"ipq807x.dtsi\"" >> "$DTS_DIR/$DEVICE_TREE"  # ÂºïÂÖ•ipq807xÂü∫Á°ÄÈÖçÁΩÆ
          echo "" >> "$DTS_DIR/$DEVICE_TREE"
          echo "/ {" >> "$DTS_DIR/$DEVICE_TREE"
          echo "  model = \"JD BE6500\";" >> "$DTS_DIR/$DEVICE_TREE"
          echo "  compatible = \"qcom,ipq5332\", \"qcom,ipq5000\", \"qcom,ipq807x\";" >> "$DTS_DIR/$DEVICE_TREE"
          echo "" >> "$DTS_DIR/$DEVICE_TREE"
          echo "  chosen {" >> "$DTS_DIR/$DEVICE_TREE"
          echo "    bootargs = \"earlycon=msm_serial_dm,0x1a10000 console=ttyMSM0,115200n8\";" >> "$DTS_DIR/$DEVICE_TREE"
          echo "  };" >> "$DTS_DIR/$DEVICE_TREE"
          echo "" >> "$DTS_DIR/$DEVICE_TREE"
          echo "  memory@80000000 {" >> "$DTS_DIR/$DEVICE_TREE"
          echo "    device_type = \"memory\";" >> "$DTS_DIR/$DEVICE_TREE"
          echo "    reg = <0x80000000 0x40000000>; /* 1GB */" >> "$DTS_DIR/$DEVICE_TREE"
          echo "  };" >> "$DTS_DIR/$DEVICE_TREE"
          echo "" >> "$DTS_DIR/$DEVICE_TREE"
          echo "  # ÁΩëÁªúËÆæÂ§áÈÖçÁΩÆÔºàÊ†πÊçÆBE6500ÂÆûÈôÖÁ°¨‰ª∂Ë∞ÉÊï¥Ôºâ" >> "$DTS_DIR/$DEVICE_TREE"
          echo "  ethernet@1a10000 {" >> "$DTS_DIR/$DEVICE_TREE"
          echo "    compatible = \"qcom,ipq8074-gmac\", \"qcom,ipq8064-gmac\";" >> "$DTS_DIR/$DEVICE_TREE"
          echo "    reg = <0x1a10000 0x10000>;" >> "$DTS_DIR/$DEVICE_TREE"
          echo "    interrupts = <0 42 4>;" >> "$DTS_DIR/$DEVICE_TREE"
          echo "    qcom,phy-handle = <&switch0_phy0>;" >> "$DTS_DIR/$DEVICE_TREE"
          echo "    qcom,mdio-bus = <&mdio>;" >> "$DTS_DIR/$DEVICE_TREE"
          echo "    qcom,port-id = <0>;" >> "$DTS_DIR/$DEVICE_TREE"
          echo "    qcom,rxq-pool = <0>;" >> "$DTS_DIR/$DEVICE_TREE"
          echo "    qcom,txq-pool = <0>;" >> "$DTS_DIR/$DEVICE_TREE"
          echo "    qcom,ptp-clock = <0>;" >> "$DTS_DIR/$DEVICE_TREE"
          echo "  };" >> "$DTS_DIR/$DEVICE_TREE"
          echo "" >> "$DTS_DIR/$DEVICE_TREE"
          echo "  mdio@1a14000 {" >> "$DTS_DIR/$DEVICE_TREE"
          echo "    compatible = \"qcom,ipq8074-mdio\";" >> "$DTS_DIR/$DEVICE_TREE"
          echo "    reg = <0x1a14000 0x1000>;" >> "$DTS_DIR/$DEVICE_TREE"
          echo "    #address-cells = <1>;" >> "$DTS_DIR/$DEVICE_TREE"
          echo "    #size-cells = <0>;" >> "$DTS_DIR/$DEVICE_TREE"
          echo "  };" >> "$DTS_DIR/$DEVICE_TREE"
          echo "};" >> "$DTS_DIR/$DEVICE_TREE"
          
          echo "ËÆæÂ§áÊ†ëÂÜÖÂÆπ:"
          cat "$DTS_DIR/$DEVICE_TREE"
        fi
        
        # ÁîüÊàêfeedsÈÖçÁΩÆÔºàÊåáÂêëipq807xÊ∫êÔºâ
        if [ ! -f "feeds.conf.default" ]; then
          echo "ÁîüÊàêfeedsÈÖçÁΩÆÊñá‰ª∂..."
          > feeds.conf.default
          
          echo "src-gz openwrt_core https://openwrt.lienz.net/snapshots/targets/ipq807x/generic/packages" >> feeds.conf.default
          echo "src-gz openwrt_base https://openwrt.lienz.net/snapshots/packages/aarch64_cortex-a53/base" >> feeds.conf.default
          echo "src-gz openwrt_luci https://openwrt.lienz.net/snapshots/packages/aarch64_cortex-a53/luci" >> feeds.conf.default
          echo "src-gz openwrt_packages https://openwrt.lienz.net/snapshots/packages/aarch64_cortex-a53/packages" >> feeds.conf.default
          echo "src-git lienol https://github.com/Lienol/openwrt-package" >> feeds.conf.default
          
          echo "feedsÈÖçÁΩÆÂÜÖÂÆπ:"
          cat feeds.conf.default
        fi
        
        # Êõ¥Êñ∞Feeds
        echo "ÂºÄÂßãÊõ¥Êñ∞feeds..."
        rm -rf feeds/*
        for i in {1..5}; do
          echo "Â∞ùËØï $i/5 Êõ¥Êñ∞feeds..."
          ./scripts/feeds update -a 2>&1 | tee feeds_update.log
          if [ $? -eq 0 ]; then
            echo "‚úÖ FeedsÊõ¥Êñ∞ÊàêÂäüÔºåÂºÄÂßãÂÆâË£Ö..."
            ./scripts/feeds install -a 2>&1 | tee feeds_install.log
            if [ $? -eq 0 ]; then
              PACKAGE_COUNT=$(./scripts/feeds list | grep -vE '^#|^$' | wc -l)
              echo "‚úÖ ÊâæÂà∞ $PACKAGE_COUNT ‰∏™ËΩØ‰ª∂ÂåÖ"
              
              # ÂÜôÂÖ•ÁõÆÊ†áÈÖçÁΩÆ
              echo "CONFIG_TARGET_ipq807x=y" >> .config
              echo "CONFIG_TARGET_ipq807x_generic=y" >> .config
              echo "CONFIG_TARGET_IPQ807X_DEVICE_generic=y" >> .config  # ÈÄöÁî®ÁõÆÊ†áÔºåÈÄöËøáËÆæÂ§áÊ†ëË¶ÜÁõñ
              break
            else
              echo "‚ùå FeedsÂÆâË£ÖÂ§±Ë¥•"
              cat feeds_install.log
            fi
          else
            echo "‚ùå FeedsÊõ¥Êñ∞Â§±Ë¥•"
            cat feeds_update.log
          fi
          
          echo "Ê∏ÖÁêÜÂπ∂ÈáçËØï..."
          rm -rf feeds/*
          sleep 15
        done
        
        if [ ! -d "feeds" ]; then
          echo "üí• FeedsÊõ¥Êñ∞Â§±Ë¥•ÔºåÈÄÄÂá∫"
          cat feeds_update.log
          exit 1
        fi

    - name: Customize feeds (Part 1)
      run: |
        if [ -f "$GITHUB_WORKSPACE/scripts/$DIY_P1_SH" ]; then
          cd $OPENWRT_PATH
          chmod +x $GITHUB_WORKSPACE/scripts/$DIY_P1_SH
          echo "ÊâßË°åËá™ÂÆö‰πâËÑöÊú¨ $DIY_P1_SH..."
          $GITHUB_WORKSPACE/scripts/$DIY_P1_SH
        else
          echo "‚ö†Ô∏è Êú™ÊâæÂà∞Ëá™ÂÆö‰πâËÑöÊú¨Ôºå‰ΩøÁî®ÈªòËÆ§ÈÖçÁΩÆ"
        fi

    - name: Set terminal environment
      run: |
        echo "TERM=dumb" >> $GITHUB_ENV
        echo "Êó†‰∫∫‰∫§‰∫íÁªàÁ´ØÁéØÂ¢ÉÂ∑≤ËÆæÁΩÆ"

    - name: Fix missing dependencies
      run: |
        cd $OPENWRT_PATH
        # ÁßªÈô§ÂèØËÉΩÂÜ≤Á™ÅÁöÑËΩØ‰ª∂ÂåÖ
        sed -i '/CONFIG_PACKAGE_luci-app-samba/d' .config
        sed -i '/CONFIG_PACKAGE_luci-app-mwan3helper/d' .config
        
        # Ê∑ªÂä†IPQ5332ÂøÖË¶ÅÈ©±Âä®
        echo "CONFIG_PACKAGE_kmod-ath11k-ct=y" >> .config       # Wi-Fi 7È©±Âä®
        echo "CONFIG_PACKAGE_kmod-qca-ppe=y" >> .config        # PPEÂä†ÈÄüÊ®°Âùó
        echo "CONFIG_PACKAGE_kmod-ledtrig-netdev=y" >> .config # ÁΩëÁªúÊåáÁ§∫ÁÅØÈ©±Âä®
        echo "CONFIG_PACKAGE_ath11k-firmware-qca64=y" >> .config # IPQ5332‰∏ìÁî®Âõ∫‰ª∂
        
        # Ê∑ªÂä†Áº∫Â§±ÁöÑ‰æùËµñ
        echo "CONFIG_PACKAGE_luci-app-samba4=y" >> .config
        echo "CONFIG_PACKAGE_pdnsd-alt=y" >> .config
        echo "CONFIG_PACKAGE_chinadns-ng=y" >> .config
        echo "CONFIG_PACKAGE_dns2socks=y" >> .config
        echo "CONFIG_PACKAGE_tcping=y" >> .config
        echo "CONFIG_PACKAGE_upx=y" >> .config

    - name: Customize configuration (Part 2)
      run: |
        if [ -f "$GITHUB_WORKSPACE/scripts/$DIY_P2_SH" ]; then
          cd $OPENWRT_PATH
          chmod +x $GITHUB_WORKSPACE/scripts/$DIY_P2_SH
          echo "ÊâßË°åËá™ÂÆö‰πâÈÖçÁΩÆËÑöÊú¨ $DIY_P2_SH..."
          $GITHUB_WORKSPACE/scripts/$DIY_P2_SH
        else
          echo "‚ö†Ô∏è Êú™ÊâæÂà∞Ëá™ÂÆö‰πâËÑöÊú¨"
        fi

    - name: Download package dependencies
      run: |
        cd $OPENWRT_PATH
        echo "ÂºÄÂßã‰∏ãËΩΩÂåÖ‰æùËµñ..."
        make download -j$(nproc) V=s
        DOWNLOAD_STATUS=$?
        
        # Ê∏ÖÁêÜÊó†Êïà‰∏ãËΩΩ
        find dl -size -1024c -exec rm -f {} \;
        
        if [ $DOWNLOAD_STATUS -ne 0 ]; then
          echo "‚ö†Ô∏è ‰∏ãËΩΩÂèØËÉΩÂ≠òÂú®ÈîôËØØÔºåÁªßÁª≠ÊûÑÂª∫..."
        else
          echo "‚úÖ ‰æùËµñ‰∏ãËΩΩÂÆåÊàê"
        fi

    - name: Build firmware
      run: |
        cd $OPENWRT_PATH
        echo "ÂºÄÂßãÁºñËØëÂõ∫‰ª∂... (IPQ5332‰∏ìÁî®)"
        echo "‰ΩøÁî® $(nproc) Á∫øÁ®ãÁºñËØë..."
        
        # Âπ∂Ë°åÁºñËØëÔºåÂ§±Ë¥•ÂàôÂçïÁ∫øÁ®ãÈáçËØï
        make -j$(nproc) V=s || make -j1 V=s
        
        if [ $? -ne 0 ]; then
          echo "‚ùå ÁºñËØëÂ§±Ë¥•"
          find . -name "*.log" -exec cp {} error_logs/ \;
          tar -czf error_logs.tar.gz error_logs
          exit 1
        else
          echo "‚úÖ Âõ∫‰ª∂ÁºñËØëÊàêÂäü"
        fi

    - name: Check space usage
      run: |
        echo "Á£ÅÁõòÁ©∫Èó¥‰ΩøÁî®:"
        df -h
        echo "OpenWrt binÁõÆÂΩïÂ§ßÂ∞è:"
        du -sh $OPENWRT_PATH/bin

    - name: Collect firmware files
      id: collect
      run: |
        cd $OPENWRT_PATH/bin/targets/*/*
        FIRMWARE_PATH=$(pwd)
        echo "FIRMWARE_PATH=$FIRMWARE_PATH" >> $GITHUB_ENV
        echo "::set-output name=status::success"
        
        if [ -n "$(ls $FIRMWARE_PATH/*.bin 2>/dev/null)" ]; then
          echo "FILES_AVAILABLE=true" >> $GITHUB_ENV
          echo "‚úÖ ÊâæÂà∞Âõ∫‰ª∂Êñá‰ª∂:"
          ls -lh $FIRMWARE_PATH/*.bin
        else
          echo "FILES_AVAILABLE=false" >> $GITHUB_ENV
          echo "‚ùå Êú™ÊâæÂà∞Âõ∫‰ª∂Êñá‰ª∂ÔºåÂèØÁî®Êñá‰ª∂:"
          ls -lh $FIRMWARE_PATH/* || true
        fi

    - name: Upload firmware as artifact
      if: steps.collect.outputs.status == 'success' && env.FILES_AVAILABLE == 'true' && env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-Firmware-${{ github.sha }}
        path: ${{ env.FIRMWARE_PATH }}/*
        retention-days: 30
        if-no-files-found: error

    - name: Upload firmware to Release
      if: steps.collect.outputs.status == 'success' && env.FILES_AVAILABLE == 'true' && env.UPLOAD_RELEASE == 'true' && github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.FIRMWARE_PATH }}/*
        tag_name: ${{ github.ref_name }}
        body: |
          OpenWrt firmware for JD BE6500 (IPQ5332)
          Built from commit ${{ github.sha }}
          Date: $(date +%Y-%m-%d)
      env:
        GITHUB_TOKEN: ${{ secrets.MY_TOKEN }}
