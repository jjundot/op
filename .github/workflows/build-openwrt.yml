name: Build OpenWrt for JD BE6500 (IPQ5332)

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      with_wsdd2:
        description: 'ç¼–è¯‘åŒ…å« WSDD2 (SMB3 æ”¯æŒ)'
        required: false
        default: 'true'
        type: boolean
      with_samba4:
        description: 'ç¼–è¯‘åŒ…å« Samba4'
        required: false
        default: 'true'
        type: boolean
      with_docker:
        description: 'ç¼–è¯‘åŒ…å« Docker æ”¯æŒ'
        required: false
        default: 'true'
        type: boolean
  release:
    types: published  # å‘å¸ƒReleaseæ—¶è§¦å‘

env:
  LIENOL_REPO: https://github.com/Lienol/openwrt          # Lienolä¸»ä»“åº“
  LIENOL_BRANCH: 23.05                                  # ä½¿ç”¨23.05åˆ†æ”¯
  ARCH: ipq807x                                          # ä½¿ç”¨ipq807xç›®æ ‡ï¼ˆå…¼å®¹IPQ5332ï¼‰
  SUBARCH: generic                                       # é€šç”¨å­æ¶æ„
  CPU_ARCH: aarch64_cortex-a53                           # CPUæ¶æ„
  FEEDS_CONF: feeds.conf.default                         # Feedsé…ç½®æ–‡ä»¶
  CONFIG_FILE: .config                                   # ç¼–è¯‘é…ç½®æ–‡ä»¶
  DIY_P1_SH: diy-part1.sh                                # è‡ªå®šä¹‰è„šæœ¬1
  DIY_P2_SH: diy-part2.sh                                # è‡ªå®šä¹‰è„šæœ¬2
  UPLOAD_BIN_DIR: false                                  # ä¸ä¸Šä¼ binç›®å½•
  UPLOAD_FIRMWARE: true                                  # ä¸Šä¼ å›ºä»¶
  UPLOAD_RELEASE: true                                   # å‘å¸ƒåˆ°Release
  UPLOAD_CDN: false                                      # ä¸Šä¼ åˆ°CDN
  TZ: Asia/Shanghai                                      # æ—¶åŒº
  GITHUB_TOKEN: ${{ secrets.MY_TOKEN }}                  # GitHub Token
  CACHE_DIR: ${{ github.workspace }}/openwrt             # ç¼“å­˜ç›®å½•
  OPENWRT_PATH: ${{ github.workspace }}/openwrt     

jobs:
  build:
    runs-on: ubuntu-22.04                                 # ç›´æ¥ä½¿ç”¨Ubuntuç¯å¢ƒ

    steps:
    - name: æ£€æŸ¥ç¯å¢ƒ
      run: |
        df -hT
        free -h
        cat /proc/cpuinfo
        cat /etc/os-release
    - name: å®‰è£…OpenWrtç¼–è¯‘ä¾èµ–
      run: |
        sudo apt-get update
        # å®‰è£…OpenWrtå®˜æ–¹æ¨èçš„ç¼–è¯‘ä¾èµ–
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3 python3-distutils python3-setuptools \
          python3-dev rsync subversion swig time unzip wget xmlto zlib1g-dev \
          quilt autopoint libtool-bin gperf flex bison gettext-base asciidoc dos2unix
    - name: é…ç½®Gitå‡­è¯
      run: |
        git config --global credential.helper store
        echo "https://${GITHUB_TOKEN}:@github.com" > ~/.git-credentials
        echo "Gitå‡­è¯å·²é…ç½®"
    - name: å…‹éš†Lienolä»“åº“ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
      run: |
        rm -rf openwrt
        for i in {1..5}; do
          echo "=== ç¬¬ $i æ¬¡å…‹éš†å°è¯• ==="
          git clone --depth=1 $LIENOL_REPO -b $LIENOL_BRANCH openwrt
          if [ $? -eq 0 ]; then
            echo "âœ… ä»“åº“å…‹éš†æˆåŠŸ"
            break
          fi
          echo "âŒ å…‹éš†å¤±è´¥ï¼Œ15ç§’åé‡è¯•..."
          sleep 15
        done
        if [ ! -d "openwrt" ]; then
          echo "ğŸ’¥ äº”æ¬¡å…‹éš†å¤±è´¥ï¼Œé€€å‡º"
          exit 1
        fi
        cd openwrt
        echo "OPENWRT_PATH=$(pwd)" >> $GITHUB_ENV
        echo $GITHUB_ENV
        echo $OPENWRT_PATH
        git log -1
    - name: ç¼“å­˜ä¾èµ–åŒ…ï¼ˆåŠ é€Ÿç¼–è¯‘ï¼‰
      uses: actions/cache@v3
      with:
        path: ${{ env.CACHE_DIR }}
        key: ${{ runner.os }}-openwrt-dl-${{ hashFiles('openwrt/dl/**', 'feeds.conf.default') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-dl-

    - name: ä¸‹è½½ä¾èµ–åŒ…ï¼ˆå¸¦ç¼“å­˜ï¼‰
      run: |
        cd $OPENWRT_PATH
        pwd
        ls -la
        [ cat .config ] || echo ".config not"
        cat feeds.conf.default
        ls ./target
        tree ./target
    
   
