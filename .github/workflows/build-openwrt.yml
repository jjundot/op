name: Build OpenWrt for JD BE6500 (IPQ5332)

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
    inputs:
      with_wsdd2:
        description: 'ç¼–è¯‘åŒ…å« WSDD2 (SMB3 æ”¯æŒ)'
        required: false
        default: 'true'
        type: boolean
      with_samba4:
        description: 'ç¼–è¯‘åŒ…å« Samba4'
        required: false
        default: 'true'
        type: boolean
      with_docker:
        description: 'ç¼–è¯‘åŒ…å« Docker æ”¯æŒ'
        required: false
        default: 'true'
        type: boolean
  release:
    types: published  # å‘å¸ƒReleaseæ—¶è§¦å‘

env:
  LIENOL_REPO: https://github.com/Lienol/openwrt          # Lienolä¸»ä»“åº“
  LIENOL_BRANCH: 23.05                                  # ä½¿ç”¨23.05åˆ†æ”¯
  ARCH: ipq807x                                          # ä½¿ç”¨ipq807xç›®æ ‡ï¼ˆå…¼å®¹IPQ5332ï¼‰
  SUBARCH: generic                                       # é€šç”¨å­æ¶æ„
  CPU_ARCH: aarch64_cortex-a53                           # CPUæ¶æ„
  FEEDS_CONF: feeds.conf.default                         # Feedsé…ç½®æ–‡ä»¶
  CONFIG_FILE: .config                                   # ç¼–è¯‘é…ç½®æ–‡ä»¶
  DIY_P1_SH: diy-part1.sh                                # è‡ªå®šä¹‰è„šæœ¬1
  DIY_P2_SH: diy-part2.sh                                # è‡ªå®šä¹‰è„šæœ¬2
  UPLOAD_BIN_DIR: false                                  # ä¸ä¸Šä¼ binç›®å½•
  UPLOAD_FIRMWARE: true                                  # ä¸Šä¼ å›ºä»¶
  UPLOAD_RELEASE: true                                   # å‘å¸ƒåˆ°Release
  UPLOAD_CDN: false                                      # ä¸Šä¼ åˆ°CDN
  TZ: Asia/Shanghai                                      # æ—¶åŒº
  GITHUB_TOKEN: ${{ secrets.MY_TOKEN }}                  # GitHub Token
  CACHE_DIR: ${{ github.workspace }}/.cache/openwrt       # ç¼“å­˜ç›®å½•

jobs:
  build:
    runs-on: ubuntu-22.04                                 # ç›´æ¥ä½¿ç”¨Ubuntuç¯å¢ƒ

    steps:
    - name: æ£€æŸ¥ç¯å¢ƒ
      run: |
        df -hT
        free -h
        cat /proc/cpuinfo
        cat /etc/os-release

    - name: å®‰è£…OpenWrtç¼–è¯‘ä¾èµ–
      run: |
        sudo apt-get update
        # å®‰è£…OpenWrtå®˜æ–¹æ¨èçš„ç¼–è¯‘ä¾èµ–
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3 python3-distutils python3-setuptools \
          python3-dev rsync subversion swig time unzip wget xmlto zlib1g-dev \
          quilt autopoint libtool-bin gperf flex bison gettext-base asciidoc dos2unix \
          python3-pyelftools python3-pip
        pip install pyelftools

    - name: é…ç½®Gitå‡­è¯
      run: |
        git config --global credential.helper store
        echo "https://${GITHUB_TOKEN}:@github.com" > ~/.git-credentials
        echo "Gitå‡­è¯å·²é…ç½®"

    - name: å…‹éš†Lienolä»“åº“ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
      run: |
        rm -rf openwrt
        for i in {1..5}; do
          echo "=== ç¬¬ $i æ¬¡å…‹éš†å°è¯• ==="
          git clone --depth=1 $LIENOL_REPO -b $LIENOL_BRANCH openwrt
          if [ $? -eq 0 ]; then
            echo "âœ… ä»“åº“å…‹éš†æˆåŠŸ"
            break
          fi
          echo "âŒ å…‹éš†å¤±è´¥ï¼Œ15ç§’åé‡è¯•..."
          sleep 15
        done
        if [ ! -d "openwrt" ]; then
          echo "ğŸ’¥ äº”æ¬¡å…‹éš†å¤±è´¥ï¼Œé€€å‡º"
          exit 1
        fi
        cd openwrt
        echo "OPENWRT_PATH=$(pwd)" >> $GITHUB_ENV
        git log -1

    - name: ç¼“å­˜ä¾èµ–åŒ…ï¼ˆåŠ é€Ÿç¼–è¯‘ï¼‰
      uses: actions/cache@v3
      with:
        path: ${{ env.CACHE_DIR }}
        key: ${{ runner.os }}-openwrt-dl-${{ hashFiles('openwrt/dl/**', 'feeds.conf.default', '.config') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-dl-

    - name: æ™ºèƒ½Feedsé…ç½®ï¼ˆå»é‡+ä¾èµ–ä¿®å¤ï¼‰
      run: |
        cd $OPENWRT_PATH
        # å¤‡ä»½åŸå§‹Feedsé…ç½®
        cp $FEEDS_CONF ${FEEDS_CONF}.bak
        
        # 1. æ¸…ç†é‡å¤æºå¹¶ç¡®ä¿å”¯ä¸€æ€§
        UNIQUE_FEEDS=$(cat $FEEDS_CONF | grep -v '^#' | sort -u | awk '!a[$2]++')
        > $FEEDS_CONF
        echo "$UNIQUE_FEEDS" >> $FEEDS_CONF
        
        # 2. æ·»åŠ å¿…è¦æºï¼ˆä½¿ç”¨å”¯ä¸€åç§°ï¼‰
        if ! grep -q "lienol" $FEEDS_CONF; then
          echo "src-git lienol https://github.com/Lienol/openwrt-package" >> $FEEDS_CONF
        fi
        if ! grep -q "kenzo" $FEEDS_CONF; then
          echo "src-git kenzo https://github.com/kenzok8/openwrt-packages" >> $FEEDS_CONF
        fi
        if ! grep -q "small" $FEEDS_CONF; then
          echo "src-git small https://github.com/kenzok8/small" >> $FEEDS_CONF
        fi
        
        # 3. ä½¿ç”¨å”¯ä¸€åç§°æ·»åŠ å®˜æ–¹æº
        if ! grep -q "openwrt_packages" $FEEDS_CONF; then
          echo "src-git openwrt_packages https://git.openwrt.org/feed/packages.git^openwrt-23.05" >> $FEEDS_CONF
        fi
        if ! grep -q "openwrt_luci" $FEEDS_CONF; then
          echo "src-git openwrt_luci https://git.openwrt.org/project/luci.git^openwrt-23.05" >> $FEEDS_CONF
        fi
        if ! grep -q "openwrt_routing" $FEEDS_CONF; then
          echo "src-git openwrt_routing https://git.openwrt.org/feed/routing.git^openwrt-23.05" >> $FEEDS_CONF
        fi
        if ! grep -q "openwrt_telephony" $FEEDS_CONF; then
          echo "src-git openwrt_telephony https://git.openwrt.org/feed/telephony.git^openwrt-23.05" >> $FEEDS_CONF
        fi
        
        # 4. æ·»åŠ IPQ5332ç‰¹å®šé©±åŠ¨æº
        if ! grep -q "ipq5332_drivers" $FEEDS_CONF; then
          echo "src-git ipq5332_drivers https://github.com/yourusername/openwrt-ipq5332-drivers" >> $FEEDS_CONF
        fi
        
        # 5. æ˜¾ç¤ºæœ€ç»ˆFeedsé…ç½®
        echo "=== æœ€ç»ˆFeedsé…ç½® ==="
        cat $FEEDS_CONF

    - name: ä¾èµ–å¼ºåŒ–å®‰è£…ï¼ˆè§£å†³å†å²æŠ¥é”™ï¼‰
      run: |
        cd $OPENWRT_PATH
        # æ¸…ç†æ—§Feeds
        rm -rf feeds/*
        
        # å¤šè½®Feedsæ›´æ–°ï¼ˆè§£å†³ç½‘ç»œæ³¢åŠ¨ï¼‰
        for i in {1..3}; do
          echo "=== ç¬¬ $i æ¬¡Feedsæ›´æ–° ==="
          ./scripts/feeds update -a 2>&1 | tee feeds_update_${i}.log
          if [ $? -eq 0 ]; then
            break
          fi
          echo "æ›´æ–°å¤±è´¥ï¼Œ10ç§’åé‡è¯•..."
          sleep 10
        done
        
        # å®‰è£…Feedsï¼ˆå¸¦ä¾èµ–ä¿®å¤ï¼‰
        ./scripts/feeds install -a 2>&1 | tee feeds_install.log
        
        # ç¡®ä¿IPQ5332é©±åŠ¨è¢«å®‰è£…
        if ! ./scripts/feeds list | grep -q "kmod-ath11k-ct"; then
          echo "âš ï¸ æœªæ‰¾åˆ°IPQ5332 Wi-Fié©±åŠ¨ï¼Œå°è¯•é€šè¿‡å®˜æ–¹Feedsç³»ç»Ÿè·å–..."
          
          # ä¿®æ­£ï¼šé€šè¿‡å®˜æ–¹Feedsç³»ç»Ÿå¼ºåˆ¶æ›´æ–°æ— çº¿é©±åŠ¨
          echo "src-git wireless https://git.openwrt.org/feed/wireless.git^openwrt-23.05" >> feeds.conf
          echo "src-git packages https://git.openwrt.org/feed/packages.git^openwrt-23.05" >> feeds.conf
          
          # é‡æ–°æ›´æ–°Feeds
          ./scripts/feeds update wireless packages
          ./scripts/feeds install -a -f -p wireless
          ./scripts/feeds install -a -f -p packages
          
          # å†æ¬¡æ£€æŸ¥é©±åŠ¨æ˜¯å¦å­˜åœ¨
          if ! ./scripts/feeds list | grep -q "kmod-ath11k-ct"; then
            echo "âŒ å®˜æ–¹Feedsä¸­ä»æœªæ‰¾åˆ°ath11ké©±åŠ¨ï¼Œå°è¯•æ‰‹åŠ¨é›†æˆ..."
            
            # åˆ›å»ºé©±åŠ¨ç›®å½•
            mkdir -p package/kernel/ath11k-ct
            
            # ä»OpenWrtæºç ä¸­æå–å¿…è¦æ–‡ä»¶ï¼ˆä½¿ç”¨å†…ç½®tarå‘½ä»¤ï¼‰
            wget -qO- "https://git.openwrt.org/?p=openwrt/openwrt.git;a=snapshot;h=refs/heads/openwrt-23.05;sf=tgz" | tar -xz -C /tmp
            
            # å¤åˆ¶ath11kç›¸å…³æ–‡ä»¶
            if [ -d "/tmp/openwrt-openwrt-23.05/package/kernel/ath11k" ]; then
              cp -r /tmp/openwrt-openwrt-23.05/package/kernel/ath11k package/kernel/
              echo "âœ… å·²ä»OpenWrtæºç å¿«ç…§ä¸­æå–ath11ké©±åŠ¨"
            elif [ -d "/tmp/openwrt-openwrt-23.05/package/kernel/mac80211" ]; then
              cp -r /tmp/openwrt-openwrt-23.05/package/kernel/mac80211 package/kernel/
              echo "âœ… å·²ä»OpenWrtæºç å¿«ç…§ä¸­æå–mac80211é©±åŠ¨"
            else
              echo "âŒ æ— æ³•ä»OpenWrtæºç ä¸­è·å–æ— çº¿é©±åŠ¨"
              
              # å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨å›é€€ç‰ˆæœ¬çš„é©±åŠ¨
              echo "å°è¯•ä½¿ç”¨å›é€€ç‰ˆæœ¬çš„ath11ké©±åŠ¨..."
              mkdir -p package/kernel/ath11k-ct
              
              # åˆ›å»ºåŸºæœ¬Makefileï¼ˆä½¿ç”¨echoæ›¿ä»£cat << EOFï¼‰
              echo 'include $(TOPDIR)/rules.mk' > package/kernel/ath11k-ct/Makefile
              echo 'include $(INCLUDE_DIR)/kernel.mk' >> package/kernel/ath11k-ct/Makefile
              echo '' >> package/kernel/ath11k-ct/Makefile
              echo 'PKG_NAME:=ath11k-ct' >> package/kernel/ath11k-ct/Makefile
              echo 'PKG_VERSION:=2023.05' >> package/kernel/ath11k-ct/Makefile
              echo 'PKG_RELEASE:=1' >> package/kernel/ath11k-ct/Makefile
              echo '' >> package/kernel/ath11k-ct/Makefile
              echo 'PKG_SOURCE_URL:=https://git.openwrt.org/project/libs/ath11k-ct.git' >> package/kernel/ath11k-ct/Makefile
              echo 'PKG_SOURCE_PROTO:=git' >> package/kernel/ath11k-ct/Makefile
              echo 'PKG_SOURCE_VERSION:=openwrt-23.05' >> package/kernel/ath11k-ct/Makefile
              echo 'PKG_MIRROR_HASH:=skip' >> package/kernel/ath11k-ct/Makefile
              echo '' >> package/kernel/ath11k-ct/Makefile
              echo 'PKG_MAINTAINER:=John Doe <john@example.com>' >> package/kernel/ath11k-ct/Makefile
              echo 'PKG_LICENSE:=GPL-2.0-only' >> package/kernel/ath11k-ct/Makefile
              echo 'PKG_LICENSE_FILES:=LICENSE' >> package/kernel/ath11k-ct/Makefile
              echo '' >> package/kernel/ath11k-ct/Makefile
              echo 'include $(INCLUDE_DIR)/package.mk' >> package/kernel/ath11k-ct/Makefile
              echo '' >> package/kernel/ath11k-ct/Makefile
              echo 'define KernelPackage/ath11k-ct' >> package/kernel/ath11k-ct/Makefile
              echo '  SUBMENU:=Wireless Drivers' >> package/kernel/ath11k-ct/Makefile
              echo '  TITLE:=Atheros ath11k wireless driver (CT version)' >> package/kernel/ath11k-ct/Makefile
              echo '  DEPENDS:=+kmod-cfg80211 +kmod-usb-core +kmod-mac80211' >> package/kernel/ath11k-ct/Makefile
              echo '  KCONFIG:= \' >> package/kernel/ath11k-ct/Makefile
              echo '    CONFIG_ATH11K=m \' >> package/kernel/ath11k-ct/Makefile
              echo '    CONFIG_ATH11K_DEBUGFS=n \' >> package/kernel/ath11k-ct/Makefile
              echo '    CONFIG_ATH11K_TRACE=n' >> package/kernel/ath11k-ct/Makefile
              echo '  FILES:=$(PKG_BUILD_DIR)/compat.ko $(PKG_BUILD_DIR)/ath11k.ko' >> package/kernel/ath11k-ct/Makefile
              echo '  AUTOLOAD:=$(call AutoProbe,ath11k)' >> package/kernel/ath11k-ct/Makefile
              echo 'endef' >> package/kernel/ath11k-ct/Makefile
              echo '' >> package/kernel/ath11k-ct/Makefile
              echo 'define KernelPackage/ath11k-ct/description' >> package/kernel/ath11k-ct/Makefile
              echo '  This package contains the Atheros ath11k wireless driver' >> package/kernel/ath11k-ct/Makefile
              echo '  for newer Qualcomm Atheros chipsets.' >> package/kernel/ath11k-ct/Makefile
              echo 'endef' >> package/kernel/ath11k-ct/Makefile
              echo '' >> package/kernel/ath11k-ct/Makefile
              echo '$(eval $(call KernelPackage,ath11k-ct))' >> package/kernel/ath11k-ct/Makefile
              
              echo "âœ… å·²åˆ›å»ºath11k-cté©±åŠ¨çš„åŸºæœ¬Makefile"
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -rf /tmp/openwrt-openwrt-23.05
          else
            echo "âœ… å·²é€šè¿‡å®˜æ–¹Feedsè·å–ath11ké©±åŠ¨"
          fi
        else
          echo "âœ… IPQ5332 Wi-Fié©±åŠ¨å·²å®‰è£…"
        fi

    - name: åŸºç¡€é…ç½®ç”Ÿæˆï¼ˆä¿ç•™å¹¶å¼ºåŒ–ç›®æ ‡å¹³å°ï¼‰
      run: |
        cd $OPENWRT_PATH
        # ä¿ç•™åŸæœ‰.configé…ç½®ï¼Œä½†ç¡®ä¿ç›®æ ‡å¹³å°æ­£ç¡®è®¾ç½®
        if [ -f "$CONFIG_FILE" ]; then
          echo "âœ… æ£€æµ‹åˆ°å·²æœ‰é…ç½®æ–‡ä»¶ï¼Œä¿ç•™å¹¶æ›´æ–°ç›®æ ‡å¹³å°é…ç½®"
          # å¤‡ä»½åŸé…ç½®
          cp $CONFIG_FILE ${CONFIG_FILE}.bak
          
          # ç¡®ä¿ç›®æ ‡å¹³å°æ­£ç¡®è®¾ç½®
          sed -i '/CONFIG_TARGET_IPQ807X/d' $CONFIG_FILE
          sed -i '/CONFIG_TARGET_IPQ807X_DEVICE_jd-be6500/d' $CONFIG_FILE
          echo "CONFIG_TARGET_IPQ807X=y" >> $CONFIG_FILE
          echo "CONFIG_TARGET_IPQ807X_DEVICE_jd-be6500=y" >> $CONFIG_FILE
          echo "CONFIG_TARGET_DEVICE_PACKAGES_jd-be6500=\"kmod-ath11k-ct kmod-qca-ppe kmod-qca-nss-drv kmod-qca-nss-gmac kmod-thermal-qcom\"" >> $CONFIG_FILE
          echo "CONFIG_TARGET_KERNEL_PARTSIZE=16" >> $CONFIG_FILE
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=128" >> $CONFIG_FILE
        else
          # ç”Ÿæˆé»˜è®¤é…ç½®
          make defconfig
          
          # è®¾ç½®ç›®æ ‡å¹³å°
          echo "CONFIG_TARGET_IPQ807X=y" >> $CONFIG_FILE
          echo "CONFIG_TARGET_IPQ807X_DEVICE_jd-be6500=y" >> $CONFIG_FILE
          echo "CONFIG_TARGET_DEVICE_PACKAGES_jd-be6500=\"kmod-ath11k-ct kmod-qca-ppe kmod-qca-nss-drv kmod-qca-nss-gmac kmod-thermal-qcom\"" >> $CONFIG_FILE
          echo "CONFIG_TARGET_KERNEL_PARTSIZE=16" >> $CONFIG_FILE
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=128" >> $CONFIG_FILE
        fi
        
        # æ˜¾ç¤ºå½“å‰é…ç½®ï¼ˆç”¨äºè°ƒè¯•ï¼‰
        echo "=== å½“å‰.config è®¾å¤‡é…ç½® ==="
        grep -E "CONFIG_TARGET_IPQ807X_DEVICE|CONFIG_TARGET_DEVICE_PACKAGES" .config

    - name: è®¾å¤‡æ ‘å¼ºåˆ¶å…³è”ï¼ˆå…³é”®ä¿®æ­£ï¼‰
      run: |
        cd $OPENWRT_PATH
        echo "=== å¼ºåˆ¶å…³è”è®¾å¤‡æ ‘åˆ°ç¼–è¯‘ç³»ç»Ÿ ==="
        
        # 1. ç¡®ä¿è®¾å¤‡æ ‘ç›®å½•å­˜åœ¨
        DTS_DIR="target/linux/$ARCH/dts"
        mkdir -p "$DTS_DIR"
        
        # 2. å¤åˆ¶æˆ–ç”Ÿæˆè®¾å¤‡æ ‘æ–‡ä»¶
        DEVICE_TREE="$DTS_DIR/qcom,ipq5332-jd-be6500.dts"
        if [ ! -f "$DEVICE_TREE" ]; then
          echo "âŒ è®¾å¤‡æ ‘ä¸å­˜åœ¨ï¼Œä»ç¼“å­˜å¤åˆ¶æˆ–ç”Ÿæˆ..."
          # å‡è®¾è®¾å¤‡æ ‘å·²å­˜åœ¨äºä»“åº“ä¸­ï¼Œæˆ–ä»ç¼“å­˜å¤åˆ¶
          if [ -f "qcom,ipq5332-jd-be6500.dts" ]; then
            cp "qcom,ipq5332-jd-be6500.dts" "$DEVICE_TREE"
          else
            # ç”Ÿæˆè®¾å¤‡æ ‘ï¼ˆä½¿ç”¨echoæ›¿ä»£cat << EOFï¼‰
            echo '/dts-v1/;' > "$DEVICE_TREE"
            echo '#include "qcom,ipq5332.dtsi"' >> "$DEVICE_TREE"
            echo '#include "ipq807x.dtsi"' >> "$DEVICE_TREE"
            echo '' >> "$DEVICE_TREE"
            echo '/ {' >> "$DEVICE_TREE"
            echo '    model = "JD BE6500";' >> "$DEVICE_TREE"
            echo '    compatible = "qcom,ipq5332", "qcom,ipq5000", "qcom,ipq807x";' >> "$DEVICE_TREE"
            echo '    # ç®€åŒ–è®¾å¤‡æ ‘å†…å®¹ï¼Œå®é™…åº”ä½¿ç”¨å®Œæ•´é…ç½®' >> "$DEVICE_TREE"
            echo '};' >> "$DEVICE_TREE"
          fi
          echo "è®¾å¤‡æ ‘å·²ç”Ÿæˆ: $DEVICE_TREE"
        else
          echo "âœ… è®¾å¤‡æ ‘å·²å­˜åœ¨"
        fi
        
        # 3. ç¡®ä¿è®¾å¤‡æ ‘è¢«Makefileè¯†åˆ«ï¼ˆå…³é”®ä¿®æ­£ï¼‰
        MAKEFILE="target/linux/$ARCH/Makefile"
        if ! grep -q "jd-be6500" "$MAKEFILE"; then
          echo "âŒ è®¾å¤‡æ ‘æœªè¢«Makefileè¯†åˆ«ï¼Œæ‰‹åŠ¨æ·»åŠ ..."
          
          # å¤‡ä»½åŸMakefile
          cp "$MAKEFILE" "${MAKEFILE}.bak"
          
          # æ·»åŠ è®¾å¤‡å®šä¹‰
          sed -i "/define Device/generic/a\ \ \ \ \ DEVICE_PACKAGES += kmod-ath11k-ct kmod-qca-ppe kmod-qca-nss-drv kmod-qca-nss-gmac kmod-thermal-qcom" "$MAKEFILE"
          sed -i "/endef/a\ \ \ \ \ DEVICE_DTS := qcom,ipq5332-jd-be6500" "$MAKEFILE"
          
          if ! grep -q "qcom,ipq5332-jd-be6500" "$MAKEFILE"; then
            # å¦‚æœsedå¤±è´¥ï¼Œä½¿ç”¨è¿½åŠ æ–¹å¼
            echo "" >> "$MAKEFILE"
            echo "define Device/jd-be6500" >> "$MAKEFILE"
            echo "  \$(Device/generic)" >> "$MAKEFILE"
            echo "  DEVICE_TITLE := JD BE6500 (IPQ5332)" >> "$MAKEFILE"
            echo "  DEVICE_DTS := qcom,ipq5332-jd-be6500" >> "$MAKEFILE"
            echo "  DEVICE_PACKAGES := kmod-ath11k-ct kmod-qca-ppe kmod-qca-nss-drv kmod-qca-nss-gmac kmod-thermal-qcom" >> "$MAKEFILE"
            echo "endef" >> "$MAKEFILE"
            echo "\$(eval \$(call Device,jd-be6500))" >> "$MAKEFILE"
          fi
          
          if grep -q "jd-be6500" "$MAKEFILE"; then
            echo "âœ… è®¾å¤‡æ ‘å·²æ·»åŠ åˆ°Makefile"
          else
            echo "âŒ è®¾å¤‡æ ‘æ·»åŠ å¤±è´¥"
            exit 1
          fi
        else
          echo "âœ… è®¾å¤‡æ ‘å·²è¢«Makefileè¯†åˆ«"
        fi

    - name: åº”ç”¨diy-part1.shè„šæœ¬ï¼ˆè‡ªå®šä¹‰é…ç½®ï¼‰
      run: |
        cd $OPENWRT_PATH
        if [ -f "$DIY_P1_SH" ]; then
          echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬: $DIY_P1_SH"
          chmod +x $DIY_P1_SH
          ./$DIY_P1_SH
        else
          echo "âŒ è‡ªå®šä¹‰è„šæœ¬ä¸å­˜åœ¨: $DIY_P1_SH"
        fi

    - name: åº”ç”¨diy-part2.shè„šæœ¬ï¼ˆè‡ªå®šä¹‰é…ç½®ï¼‰
      run: |
        cd $OPENWRT_PATH
        if [ -f "$DIY_P2_SH" ]; then
          echo "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬: $DIY_P2_SH"
          chmod +x $DIY_P2_SH
          ./$DIY_P2_SH
        else
          echo "âŒ è‡ªå®šä¹‰è„šæœ¬ä¸å­˜åœ¨: $DIY_P2_SH"
        fi

    - name: ä¸‹è½½ä¾èµ–åŒ…ï¼ˆå¸¦ç¼“å­˜ï¼‰
      run: |
        cd $OPENWRT_PATH
        echo "å¼€å§‹ä¸‹è½½ä¾èµ–åŒ…..."
        
        # ä¼˜å…ˆä½¿ç”¨ç¼“å­˜
        if [ -d "${{ env.CACHE_DIR }}/dl" ]; then
          echo "ä½¿ç”¨ç¼“å­˜ä¾èµ–åŒ…..."
          cp -rf "${{ env.CACHE_DIR }}/dl" .
        fi
        
        # æ‰§è¡Œä¸‹è½½
        make download -j$(nproc) V=s
        DOWNLOAD_STATUS=$?
        
        # ä¿å­˜ç¼“å­˜
        mkdir -p "${{ env.CACHE_DIR }}/dl"
        cp -rf dl/* "${{ env.CACHE_DIR }}/dl/"
        
        # æ¸…ç†æ— æ•ˆæ–‡ä»¶
        find dl -size -1024c -exec rm -f {} \;
        
        if [ $DOWNLOAD_STATUS -ne 0 ]; then
          echo "âš ï¸ ä¸‹è½½å¯èƒ½å­˜åœ¨é”™è¯¯ï¼Œç»§ç»­æ„å»º..."
          find dl -type f -empty -exec echo "ç©ºæ–‡ä»¶: {}" \;
        else
          echo "âœ… ä¾èµ–ä¸‹è½½å®Œæˆ"
          echo "ä¸‹è½½æ–‡ä»¶æ•°: $(find dl -type f | wc -l)"
        fi

    - name: ç¼–è¯‘å›ºä»¶ï¼ˆå¸¦è¯¦ç»†é”™è¯¯æ—¥å¿—ï¼‰
      run: |
        cd $OPENWRT_PATH
        echo "å¼€å§‹ç¼–è¯‘å›ºä»¶... (IPQ5332ä¸“ç”¨)"
        echo "ä½¿ç”¨ $(nproc) çº¿ç¨‹ç¼–è¯‘..."
        
        # é…ç½®ç¼–è¯‘çº¿ç¨‹æ•°ï¼ˆæ ¹æ®CPUæ ¸å¿ƒæ•°è‡ªåŠ¨è°ƒæ•´ï¼‰
        JOBS=$(nproc)
        if [ $JOBS -gt 4 ]; then
          JOBS=4  # é™åˆ¶æœ€å¤§çº¿ç¨‹æ•°ä¸º4ï¼Œé¿å…å†…å­˜ä¸è¶³
        fi
        
        # ç”Ÿæˆé…ç½®ï¼ˆç¡®ä¿ç›®æ ‡æ­£ç¡®ï¼‰
        make defconfig
        
        # ç¬¬ä¸€é˜¶æ®µï¼šå¹¶è¡Œç¼–è¯‘
        make -j$JOBS V=s 2>&1 | tee compile_phase1.log
        PHASE1_STATUS=$?
        
        if [ $PHASE1_STATUS -ne 0 ]; then
          echo "âŒ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
          # ç¬¬äºŒé˜¶æ®µï¼šå•çº¿ç¨‹ç¼–è¯‘ï¼ˆè·å–è¯¦ç»†é”™è¯¯ï¼‰
          make -j1 V=s 2>&1 | tee compile_phase2.log
          PHASE2_STATUS=$?
          
          if [ $PHASE2_STATUS -ne 0 ]; then
            echo "ğŸ’¥ ç¼–è¯‘å½»åº•å¤±è´¥ï¼Œæ”¶é›†é”™è¯¯æ—¥å¿—..."
            # æå–å…³é”®é”™è¯¯ä¿¡æ¯
            echo "=== ç¼–è¯‘é”™è¯¯æ‘˜è¦ ==="
            grep -E "error:|fatal:|make\[.*:.*Error\]" compile_phase2.log || true
            
            # ä¿å­˜å®Œæ•´æ—¥å¿—
            mkdir -p error_logs
            cp compile_phase*.log error_logs/
            cp $(find . -name "*.err" -or -name "*.log") error_logs/ 2>/dev/null
            tar -czf error_logs.tar.gz error_logs
            exit 1
          else
            echo "âœ… å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
          fi
        else
          echo "âœ… å¹¶è¡Œç¼–è¯‘æˆåŠŸ"
        fi

    - name: å›ºä»¶å®Œæ•´æ€§æ£€æŸ¥ï¼ˆå¤šçº§è·¯å¾„æ£€æµ‹ - å…³é”®ä¿®æ­£ï¼‰
      run: |
        cd $OPENWRT_PATH
        # æ£€æµ‹ipq807xç›®æ ‡å›ºä»¶è·¯å¾„ï¼ˆä¿®æ­£å‘½åé”™è¯¯ï¼‰
        FIRMWARE_PATH=$(find . -type d -name "ipq807x" 2>/dev/null | head -n1)
        if [ -n "$FIRMWARE_PATH" ]; then
          FIRMWARE_PATH="$FIRMWARE_PATH/generic"
        else
          FIRMWARE_PATH=$(find . -type d -name "qcom" 2>/dev/null | head -n1)
          if [ -n "$FIRMWARE_PATH" ]; then
            FIRMWARE_PATH="$FIRMWARE_PATH/generic"
          else
            FIRMWARE_PATH=$(find . -type d -name "generic" 2>/dev/null | grep -E "ipq807x|qcom" | head -n1)
            if [ -z "$FIRMWARE_PATH" ]; then
              echo "âŒ æœªæ‰¾åˆ°ipq807x/qcomç›®æ ‡ç›®å½•"
              echo "å¯ç”¨ç›®æ ‡ç›®å½•:"
              find . -type d -name "*" | grep targets
              exit 1
            fi
          fi
        fi
        
        if [ ! -d "$FIRMWARE_PATH" ]; then
          FIRMWARE_PATH=$(find . -type d -name "bin" 2>/dev/null | head -n1)
          if [ -n "$FIRMWARE_PATH" ]; then
            FIRMWARE_PATH="$FIRMWARE_PATH/$ARCH/$SUBARCH"
          fi
        fi
        
        if [ ! -d "$FIRMWARE_PATH" ]; then
          echo "âŒ æœªæ‰¾åˆ°é€šç”¨å›ºä»¶ç›®å½•"
          echo "å¯ç”¨ç›®å½•:"
          find . -type d -name "bin"
          exit 1
        fi
        
        echo "FIRMWARE_PATH=$FIRMWARE_PATH" >> $GITHUB_ENV
        
        # æ£€æŸ¥å…³é”®å›ºä»¶æ–‡ä»¶ï¼ˆä¿®æ­£å‘½åè§„åˆ™ï¼‰
        REQUIRED_FILES=(
          "openwrt-$ARCH-$SUBARCH-generic-jd-be6500-squashfs-sysupgrade.bin"
          "openwrt-$ARCH-$SUBARCH-generic-rootfs.tar.gz"
          "openwrt-$ARCH-$SUBARCH-generic-ext4-fsck"
        )
        
        MISSING_FILES=()
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$FIRMWARE_PATH/$file" ]; then
            MISSING_FILES+=($file)
          fi
        done
        
        if [ ${#MISSING_FILES[@]} -gt 0 ]; then
          echo "âŒ å‘ç°ç¼ºå¤±å›ºä»¶æ–‡ä»¶: ${MISSING_FILES[*]}"
          echo "å¯ç”¨æ–‡ä»¶:"
          ls -lh $FIRMWARE_PATH/* || true
          
          # å°è¯•æŸ¥æ‰¾å…¶ä»–å¯èƒ½çš„å›ºä»¶æ–‡ä»¶
          echo "å…¶ä»–å¯èƒ½çš„å›ºä»¶æ–‡ä»¶:"
          ls -lh $FIRMWARE_PATH/*jd-be6500* || true
          exit 1
        else
          echo "âœ… æ‰€æœ‰å…³é”®å›ºä»¶æ–‡ä»¶å·²ç”Ÿæˆ"
          ls -lh $FIRMWARE_PATH/*.bin
        fi

    - name: ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        cd $OPENWRT_PATH
        RELEASE_DATE=$(date +%Y%m%d)
        COMMIT_ID=$(git rev-parse --short HEAD)
        BUILD_TIME=$(date +"%Y-%m-%d %H:%M:%S")
        BUILD_HOST=$(hostname)
        
        # ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        touch version.info
        echo "OpenWrt å›ºä»¶ for JD BE6500 (IPQ5332)" > version.info
        echo "ç¼–è¯‘æ—¶é—´: $BUILD_TIME" >> version.info
        echo "ç¼–è¯‘ä¸»æœº: $BUILD_HOST" >> version.info
        echo "Git æäº¤: $COMMIT_ID" >> version.info
        echo "Lienol åˆ†æ”¯: $LIENOL_BRANCH" >> version.info
        echo "ç›®æ ‡å¹³å°: $ARCH/$SUBARCH" >> version.info
        
        # è¾“å‡ºç‰ˆæœ¬å˜é‡
        echo "release_version=OpenWrt_${RELEASE_DATE}_${COMMIT_ID}" >> $GITHUB_ENV
        echo "release_version=OpenWrt_${RELEASE_DATE}_${COMMIT_ID}" >> $GITHUB_OUTPUT
        cat version.info

    - name: ä¸Šä¼ å›ºä»¶åˆ°Artifact
      if: env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.release_version }}
        path: |
          ${{ env.FIRMWARE_PATH }}/*.bin
          ${{ env.FIRMWARE_PATH }}/*.tar.gz
          ${{ env.FIRMWARE_PATH }}/sha256sums
          version.info
        retention-days: 30
        if-no-files-found: error

    - name: å‘å¸ƒåˆ°GitHub Release
      if: env.UPLOAD_RELEASE == 'true' && github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ env.release_version }}
        tag_name: ${{ env.release_version }}
        body_path: version.info
        files: |
          ${{ env.FIRMWARE_PATH }}/*.bin
          ${{ env.FIRMWARE_PATH }}/*.tar.gz
          ${{ env.FIRMWARE_PATH }}/sha256sums
          version.info
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.MY_TOKEN }}    
