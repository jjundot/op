# å·¥ä½œæµåç§°ï¼šä¸ºJD BE6500 (IPQ5332)æ„å»ºOpenWrtå›ºä»¶
name: Build OpenWrt for JD BE6500 (IPQ5332)

# è§¦å‘æ¡ä»¶é…ç½®
on:
  # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼Œå¯é…ç½®è¾“å…¥å‚æ•°
  workflow_dispatch:  
    # è¾“å…¥å‚æ•°ï¼šæ˜¯å¦åŒ…å«WSDD2 (SMB3æ”¯æŒ)
    inputs:
      with_wsdd2:
        description: 'ç¼–è¯‘åŒ…å« WSDD2 (SMB3 æ”¯æŒ)'
        required: false
        default: 'true'
        type: boolean
      # è¾“å…¥å‚æ•°ï¼šæ˜¯å¦åŒ…å«Samba4
      with_samba4:
        description: 'ç¼–è¯‘åŒ…å« Samba4'
        required: false
        default: 'true'
        type: boolean
      # è¾“å…¥å‚æ•°ï¼šæ˜¯å¦åŒ…å«Dockeræ”¯æŒ
      with_docker:
        description: 'ç¼–è¯‘åŒ…å« Docker æ”¯æŒ'
        required: false
        default: 'true'
        type: boolean
  # å½“å‘å¸ƒæ–°ç‰ˆæœ¬æ—¶è§¦å‘å·¥ä½œæµ
  release:
    types: published  

# å…¨å±€ç¯å¢ƒå˜é‡é…ç½®
env:
  # Lienolçš„OpenWrtä»“åº“åœ°å€
  LIENOL_REPO: https://github.com/Lienol/openwrt          
  # ä½¿ç”¨çš„OpenWrtåˆ†æ”¯
  LIENOL_BRANCH: 23.05                                  
  # ç›®æ ‡æ¶æ„
  ARCH: ipq5332                                          
  # å­æ¶æ„
  SUBARCH: generic                                       
  # CPUæ¶æ„
  CPU_ARCH: aarch64_cortex-a53                           
  # Feedsé…ç½®æ–‡ä»¶
  FEEDS_CONF: feeds.conf.default                         
  # ç¼–è¯‘é…ç½®æ–‡ä»¶
  CONFIG_FILE: .config                                   
  # è‡ªå®šä¹‰è„šæœ¬1
  DIY_P1_SH: diy-part1.sh                                
  # è‡ªå®šä¹‰è„šæœ¬2
  DIY_P2_SH: diy-part2.sh                                
  # æ˜¯å¦ä¸Šä¼ äºŒè¿›åˆ¶ç›®å½•
  UPLOAD_BIN_DIR: false                                  
  # æ˜¯å¦ä¸Šä¼ å›ºä»¶
  UPLOAD_FIRMWARE: true                                  
  # æ˜¯å¦å‘å¸ƒåˆ°Release
  UPLOAD_RELEASE: true                                   
  # æ˜¯å¦ä¸Šä¼ åˆ°CDN
  UPLOAD_CDN: false                                      
  # æ—¶åŒºè®¾ç½®
  TZ: Asia/Shanghai                                      
  # GitHubè®¤è¯ä»¤ç‰Œï¼ˆä»ä»“åº“ç§˜å¯†è·å–ï¼‰
  GITHUB_TOKEN: ${{ secrets.MY_TOKEN }}                  
  # ç¼“å­˜ç›®å½•
  CACHE_DIR: ${{ github.workspace }}/.cache/openwrt       

# ä½œä¸šå®šä¹‰
jobs:
  # ç¼–è¯‘ä½œä¸š
  build:
    # è¿è¡Œç¯å¢ƒï¼šUbuntu 22.04
    runs-on: ubuntu-22.04                                 

    steps:
    - name: æ£€æŸ¥ç¯å¢ƒ
      run: |
        # æ˜¾ç¤ºç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ
        df -hT
        # æ˜¾ç¤ºå†…å­˜ä½¿ç”¨æƒ…å†µ
        free -h
        # æ˜¾ç¤ºCPUä¿¡æ¯
        cat /proc/cpuinfo
        # æ˜¾ç¤ºæ“ä½œç³»ç»Ÿä¿¡æ¯
        cat /etc/os-release

    - name: å®‰è£…OpenWrtç¼–è¯‘ä¾èµ–
      run: |
        # æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
        sudo apt-get update
        # å®‰è£…ç¼–è¯‘æ‰€éœ€çš„ç³»ç»ŸåŒ…
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3 python3-distutils python3-setuptools \
          python3-dev rsync subversion swig time unzip wget xmlto zlib1g-dev \
          quilt autopoint libtool-bin gperf flex bison gettext-base asciidoc dos2unix \
          python3-pyelftools python3-pip
        # å®‰è£…Pythonä¾èµ–åŒ…
        pip install pyelftools

    - name: é…ç½®Gitå‡­è¯
      run: |
        # é…ç½®Gitå‡­è¯åŠ©æ‰‹
        git config --global credential.helper store
        # å†™å…¥Gitå‡­è¯ï¼ˆä½¿ç”¨GITHUB_TOKENï¼‰
        echo "https://${GITHUB_TOKEN}:@github.com" > ~/.git-credentials
        # è¾“å‡ºé…ç½®å®Œæˆä¿¡æ¯
        echo "Gitå‡­è¯å·²é…ç½®"
    - name: æ¸…ç†å·¥ä½œç›®å½•
      run: |
        # åˆ é™¤ç°æœ‰openwrtç›®å½•
        rm -rf openwrt
        # åˆ›å»ºæ–°çš„openwrtç›®å½•
        mkdir -p openwrt
    - name: å…‹éš†Lienolä»“åº“ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
      run: |
        # æ¸…ç†æ—§ä»“åº“ç›®å½•
        rm -rf openwrt
        # å¾ªç¯å°è¯•å…‹éš†ä»“åº“ï¼ˆæœ€å¤š5æ¬¡ï¼‰
        for i in {1..5}; do
          # è¾“å‡ºå½“å‰å°è¯•æ¬¡æ•°
          echo "=== ç¬¬ $i æ¬¡å…‹éš†å°è¯• ==="
          # å…‹éš†ä»“åº“ï¼ˆæ·±åº¦1ï¼ŒæŒ‡å®šåˆ†æ”¯ï¼‰
          git clone --depth=1 $LIENOL_REPO -b $LIENOL_BRANCH openwrt
          # æ£€æŸ¥å…‹éš†æ˜¯å¦æˆåŠŸ
          if [ $? -eq 0 ]; then
            echo "âœ… ä»“åº“å…‹éš†æˆåŠŸ"
            break
          fi
          # å…‹éš†å¤±è´¥æ—¶çš„æç¤ºå’Œç­‰å¾…
          echo "âŒ å…‹éš†å¤±è´¥ï¼Œ15ç§’åé‡è¯•..."
          sleep 15
        done
        # æ£€æŸ¥æ˜¯å¦æˆåŠŸå…‹éš†
        if [ ! -d "openwrt" ]; then
          echo "ğŸ’¥ äº”æ¬¡å…‹éš†å¤±è´¥ï¼Œé€€å‡º"
          exit 1
        fi
        # è¿›å…¥openwrtç›®å½•
        cd openwrt
        # è®¾ç½®OPENWRT_PATHç¯å¢ƒå˜é‡
        echo "OPENWRT_PATH=$(pwd)" >> $GITHUB_ENV
        # æ˜¾ç¤ºæœ€æ–°æäº¤ä¿¡æ¯
        git log -1
         # ç¡®ä¿å…‹éš†åˆ°æ­£ç¡®ç›®å½•
        if [ ! -d ".git" ]; then
         echo "âŒ å…‹éš†ç›®å½•ä¸æ­£ç¡®ï¼Œé€€å‡º"
         exit 1
         fi

    - name: ç¼“å­˜ä¾èµ–åŒ…ï¼ˆåŠ é€Ÿç¼–è¯‘ï¼‰
      uses: actions/cache@v3
      with:
        # ç¼“å­˜è·¯å¾„
        path: ${{ env.CACHE_DIR }}
        # ç¼“å­˜é”®ï¼ˆåŸºäºé…ç½®æ–‡ä»¶å’Œç›®æ ‡æ¶æ„ï¼‰
        key: ${{ runner.os }}-openwrt-dl-${{ hashFiles('feeds.conf.default', '.config', 'target/linux/ipq5332/**') }}
        # ç¼“å­˜æ¢å¤é”®
        restore-keys: |
          ${{ runner.os }}-openwrt-dl-
    - name: test
      run: | 
        ls ${{ github.workspace }}/.cache/openwrt
