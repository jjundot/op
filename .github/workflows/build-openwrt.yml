name: Build OpenWrt for JD BE6500 (IPQ5332)

on:
  workflow_dispatch:  # ÊâãÂä®Ëß¶Âèë
    inputs:
      with_wsdd2:
        description: 'ÁºñËØëÂåÖÂê´ WSDD2 (SMB3 ÊîØÊåÅ)'
        required: false
        default: 'true'
        type: boolean
      with_samba4:
        description: 'ÁºñËØëÂåÖÂê´ Samba4'
        required: false
        default: 'true'
        type: boolean
      with_docker:
        description: 'ÁºñËØëÂåÖÂê´ Docker ÊîØÊåÅ'
        required: false
        default: 'true'
        type: boolean
  release:
    types: published  # ÂèëÂ∏ÉReleaseÊó∂Ëß¶Âèë

env:
  LIENOL_REPO: https://github.com/Lienol/openwrt          # Lienol‰∏ª‰ªìÂ∫ì
  LIENOL_BRANCH: 23.05                                  # ‰ΩøÁî®23.05ÂàÜÊîØ
  ARCH: ipq807x                                          # ‰ΩøÁî®ipq807xÁõÆÊ†áÔºàÂÖºÂÆπIPQ5332Ôºâ
  SUBARCH: generic                                       # ÈÄöÁî®Â≠êÊû∂ÊûÑ
  CPU_ARCH: aarch64_cortex-a53                           # CPUÊû∂ÊûÑ
  FEEDS_CONF: feeds.conf.default                         # FeedsÈÖçÁΩÆÊñá‰ª∂
  CONFIG_FILE: .config                                   # ÁºñËØëÈÖçÁΩÆÊñá‰ª∂
  DIY_P1_SH: diy-part1.sh                                # Ëá™ÂÆö‰πâËÑöÊú¨1
  DIY_P2_SH: diy-part2.sh                                # Ëá™ÂÆö‰πâËÑöÊú¨2
  UPLOAD_BIN_DIR: false                                  # ‰∏ç‰∏ä‰º†binÁõÆÂΩï
  UPLOAD_FIRMWARE: true                                  # ‰∏ä‰º†Âõ∫‰ª∂
  UPLOAD_RELEASE: true                                   # ÂèëÂ∏ÉÂà∞Release
  UPLOAD_CDN: false                                      # ‰∏ä‰º†Âà∞CDN
  TZ: Asia/Shanghai                                      # Êó∂Âå∫
  GITHUB_TOKEN: ${{ secrets.MY_TOKEN }}                  # GitHub Token
  CACHE_DIR: ${{ github.workspace }}/.cache/openwrt       # ÁºìÂ≠òÁõÆÂΩï

jobs:
  build:
    runs-on: ubuntu-22.04                                 # Áõ¥Êé•‰ΩøÁî®UbuntuÁéØÂ¢É

    steps:
    - name: Ê£ÄÊü•ÁéØÂ¢É
      run: |
        df -hT
        free -h
        cat /proc/cpuinfo
        cat /etc/os-release

    - name: ÂÆâË£ÖOpenWrtÁºñËØë‰æùËµñ
      run: |
        sudo apt-get update
        # ÂÆâË£ÖOpenWrtÂÆòÊñπÊé®ËçêÁöÑÁºñËØë‰æùËµñ
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk \
          gettext git java-propose-classpath libelf-dev libncurses5-dev \
          libncursesw5-dev libssl-dev python3 python3-distutils python3-setuptools \
          python3-dev rsync subversion swig time unzip wget xmlto zlib1g-dev \
          quilt autopoint libtool-bin gperf flex bison gettext-base asciidoc dos2unix \
          python3-pyelftools python3-pip
        pip install pyelftools

    - name: ÈÖçÁΩÆGitÂá≠ËØÅ
      run: |
        git config --global credential.helper store
        echo "https://${GITHUB_TOKEN}:@github.com" > ~/.git-credentials
        echo "GitÂá≠ËØÅÂ∑≤ÈÖçÁΩÆ"

    - name: ÂÖãÈöÜLienol‰ªìÂ∫ìÔºàÂ∏¶ÈáçËØïÊú∫Âà∂Ôºâ
      run: |
        rm -rf openwrt
        for i in {1..5}; do
          echo "=== Á¨¨ $i Ê¨°ÂÖãÈöÜÂ∞ùËØï ==="
          git clone --depth=1 $LIENOL_REPO -b $LIENOL_BRANCH openwrt
          if [ $? -eq 0 ]; then
            echo "‚úÖ ‰ªìÂ∫ìÂÖãÈöÜÊàêÂäü"
            break
          fi
          echo "‚ùå ÂÖãÈöÜÂ§±Ë¥•Ôºå15ÁßíÂêéÈáçËØï..."
          sleep 15
        done
        if [ ! -d "openwrt" ]; then
          echo "üí• ‰∫îÊ¨°ÂÖãÈöÜÂ§±Ë¥•ÔºåÈÄÄÂá∫"
          exit 1
        fi
        cd openwrt
        echo "OPENWRT_PATH=$(pwd)" >> $GITHUB_ENV
        git log -1

    - name: ÁºìÂ≠ò‰æùËµñÂåÖÔºàÂä†ÈÄüÁºñËØëÔºâ
      uses: actions/cache@v3
      with:
        path: ${{ env.CACHE_DIR }}
        key: ${{ runner.os }}-openwrt-dl-${{ hashFiles('openwrt/dl/**', 'feeds.conf.default', '.config') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-dl-

    - name: Êô∫ËÉΩFeedsÈÖçÁΩÆÔºàÂéªÈáç+‰æùËµñ‰øÆÂ§çÔºâ
      run: |
        cd $OPENWRT_PATH
        # Â§á‰ªΩÂéüÂßãFeedsÈÖçÁΩÆ
        cp $FEEDS_CONF ${FEEDS_CONF}.bak
        
        # 1. Ê∏ÖÁêÜÈáçÂ§çÊ∫êÂπ∂Á°Æ‰øùÂîØ‰∏ÄÊÄß
        UNIQUE_FEEDS=$(cat $FEEDS_CONF | grep -v '^#' | sort -u | awk '!a[$2]++')
        > $FEEDS_CONF
        echo "$UNIQUE_FEEDS" >> $FEEDS_CONF
        
        # 2. Ê∑ªÂä†ÂøÖË¶ÅÊ∫êÔºà‰ΩøÁî®ÂîØ‰∏ÄÂêçÁß∞Ôºâ
        if ! grep -q "lienol" $FEEDS_CONF; then
          echo "src-git lienol https://github.com/Lienol/openwrt-package" >> $FEEDS_CONF
        fi
        if ! grep -q "kenzo" $FEEDS_CONF; then
          echo "src-git kenzo https://github.com/kenzok8/openwrt-packages" >> $FEEDS_CONF
        fi
        if ! grep -q "small" $FEEDS_CONF; then
          echo "src-git small https://github.com/kenzok8/small" >> $FEEDS_CONF
        fi
        
        # 3. ‰ΩøÁî®ÂîØ‰∏ÄÂêçÁß∞Ê∑ªÂä†ÂÆòÊñπÊ∫ê
        if ! grep -q "openwrt_packages" $FEEDS_CONF; then
          echo "src-git openwrt_packages https://git.openwrt.org/feed/packages.git^openwrt-23.05" >> $FEEDS_CONF
        fi
        if ! grep -q "openwrt_luci" $FEEDS_CONF; then
          echo "src-git openwrt_luci https://git.openwrt.org/project/luci.git^openwrt-23.05" >> $FEEDS_CONF
        fi
        if ! grep -q "openwrt_routing" $FEEDS_CONF; then
          echo "src-git openwrt_routing https://git.openwrt.org/feed/routing.git^openwrt-23.05" >> $FEEDS_CONF
        fi
        if ! grep -q "openwrt_telephony" $FEEDS_CONF; then
          echo "src-git openwrt_telephony https://git.openwrt.org/feed/telephony.git^openwrt-23.05" >> $FEEDS_CONF
        fi
        
        # 4. Ê∑ªÂä†IPQ5332ÁâπÂÆöÈ©±Âä®Ê∫ê
        if ! grep -q "ipq5332_drivers" $FEEDS_CONF; then
          echo "src-git ipq5332_drivers https://github.com/yourusername/openwrt-ipq5332-drivers" >> $FEEDS_CONF
        fi
        
        # 5. ÊòæÁ§∫ÊúÄÁªàFeedsÈÖçÁΩÆ
        echo "=== ÊúÄÁªàFeedsÈÖçÁΩÆ ==="
        cat $FEEDS_CONF

    - name: ‰æùËµñÂº∫ÂåñÂÆâË£ÖÔºàËß£ÂÜ≥ÂéÜÂè≤Êä•ÈîôÔºâ
      run: |
        cd $OPENWRT_PATH
        # Ê∏ÖÁêÜÊóßFeeds
        rm -rf feeds/*
        
        # Â§öËΩÆFeedsÊõ¥Êñ∞ÔºàËß£ÂÜ≥ÁΩëÁªúÊ≥¢Âä®Ôºâ
        for i in {1..3}; do
          echo "=== Á¨¨ $i Ê¨°FeedsÊõ¥Êñ∞ ==="
          ./scripts/feeds update -a 2>&1 | tee feeds_update_${i}.log
          if [ $? -eq 0 ]; then
            break
          fi
          echo "Êõ¥Êñ∞Â§±Ë¥•Ôºå10ÁßíÂêéÈáçËØï..."
          sleep 10
        done
        
        # ÂÆâË£ÖFeedsÔºàÂ∏¶‰æùËµñ‰øÆÂ§çÔºâ
        ./scripts/feeds install -a 2>&1 | tee feeds_install.log
        
        # Á°Æ‰øùIPQ5332È©±Âä®Ë¢´ÂÆâË£Ö
        if ! ./scripts/feeds list | grep -q "kmod-ath11k-ct"; then
          echo "‚ö†Ô∏è Êú™ÊâæÂà∞IPQ5332 Wi-FiÈ©±Âä®ÔºåÂ∞ùËØïÈÄöËøáÂÆòÊñπFeedsÁ≥ªÁªüËé∑Âèñ..."
          
          # ‰øÆÊ≠£ÔºöÈÄöËøáÂÆòÊñπFeedsÁ≥ªÁªüÂº∫Âà∂Êõ¥Êñ∞Êó†Á∫øÈ©±Âä®
          echo "src-git wireless https://git.openwrt.org/feed/wireless.git^openwrt-23.05" >> feeds.conf
          echo "src-git packages https://git.openwrt.org/feed/packages.git^openwrt-23.05" >> feeds.conf
          
          # ÈáçÊñ∞Êõ¥Êñ∞Feeds
          ./scripts/feeds update wireless packages
          ./scripts/feeds install -a -f -p wireless
          ./scripts/feeds install -a -f -p packages
          
          # ÂÜçÊ¨°Ê£ÄÊü•È©±Âä®ÊòØÂê¶Â≠òÂú®
          if ! ./scripts/feeds list | grep -q "kmod-ath11k-ct"; then
            echo "‚ùå ÂÆòÊñπFeeds‰∏≠‰ªçÊú™ÊâæÂà∞ath11kÈ©±Âä®ÔºåÂ∞ùËØïÊâãÂä®ÈõÜÊàê..."
            
            # ÂàõÂª∫È©±Âä®ÁõÆÂΩï
            mkdir -p package/kernel/ath11k-ct
            
            # ‰ªéOpenWrtÊ∫êÁ†Å‰∏≠ÊèêÂèñÂøÖË¶ÅÊñá‰ª∂Ôºà‰ΩøÁî®ÂÜÖÁΩÆtarÂëΩ‰ª§Ôºâ
            wget -qO- "https://git.openwrt.org/?p=openwrt/openwrt.git;a=snapshot;h=refs/heads/openwrt-23.05;sf=tgz" | tar -xz -C /tmp
            
            # Â§çÂà∂ath11kÁõ∏ÂÖ≥Êñá‰ª∂
            if [ -d "/tmp/openwrt-openwrt-23.05/package/kernel/ath11k" ]; then
              cp -r /tmp/openwrt-openwrt-23.05/package/kernel/ath11k package/kernel/
              echo "‚úÖ Â∑≤‰ªéOpenWrtÊ∫êÁ†ÅÂø´ÁÖß‰∏≠ÊèêÂèñath11kÈ©±Âä®"
            elif [ -d "/tmp/openwrt-openwrt-23.05/package/kernel/mac80211" ]; then
              cp -r /tmp/openwrt-openwrt-23.05/package/kernel/mac80211 package/kernel/
              echo "‚úÖ Â∑≤‰ªéOpenWrtÊ∫êÁ†ÅÂø´ÁÖß‰∏≠ÊèêÂèñmac80211È©±Âä®"
            else
              echo "‚ùå Êó†Ê≥ï‰ªéOpenWrtÊ∫êÁ†Å‰∏≠Ëé∑ÂèñÊó†Á∫øÈ©±Âä®"
              
              # Â§áÈÄâÊñπÊ°àÔºö‰ΩøÁî®ÂõûÈÄÄÁâàÊú¨ÁöÑÈ©±Âä®
              echo "Â∞ùËØï‰ΩøÁî®ÂõûÈÄÄÁâàÊú¨ÁöÑath11kÈ©±Âä®..."
              mkdir -p package/kernel/ath11k-ct
              
              # ÂàõÂª∫Âü∫Êú¨Makefile
              echo 'include $(TOPDIR)/rules.mk' > package/kernel/ath11k-ct/Makefile
              echo 'include $(INCLUDE_DIR)/kernel.mk' >> package/kernel/ath11k-ct/Makefile
              echo '' >> package/kernel/ath11k-ct/Makefile
              echo 'PKG_NAME:=ath11k-ct' >> package/kernel/ath11k-ct/Makefile
              echo 'PKG_VERSION:=2023.05' >> package/kernel/ath11k-ct/Makefile
              echo 'PKG_RELEASE:=1' >> package/kernel/ath11k-ct/Makefile
              echo '' >> package/kernel/ath11k-ct/Makefile
              echo 'PKG_SOURCE_URL:=https://git.openwrt.org/project/libs/ath11k-ct.git' >> package/kernel/ath11k-ct/Makefile
              echo 'PKG_SOURCE_PROTO:=git' >> package/kernel/ath11k-ct/Makefile
              echo 'PKG_SOURCE_VERSION:=openwrt-23.05' >> package/kernel/ath11k-ct/Makefile
              echo 'PKG_MIRROR_HASH:=skip' >> package/kernel/ath11k-ct/Makefile
              echo '' >> package/kernel/ath11k-ct/Makefile
              echo 'PKG_MAINTAINER:=John Doe <john@example.com>' >> package/kernel/ath11k-ct/Makefile
              echo 'PKG_LICENSE:=GPL-2.0-only' >> package/kernel/ath11k-ct/Makefile
              echo 'PKG_LICENSE_FILES:=LICENSE' >> package/kernel/ath11k-ct/Makefile
              echo '' >> package/kernel/ath11k-ct/Makefile
              echo 'include $(INCLUDE_DIR)/package.mk' >> package/kernel/ath11k-ct/Makefile
              echo '' >> package/kernel/ath11k-ct/Makefile
              echo 'define KernelPackage/ath11k-ct' >> package/kernel/ath11k-ct/Makefile
              echo '  SUBMENU:=Wireless Drivers' >> package/kernel/ath11k-ct/Makefile
              echo '  TITLE:=Atheros ath11k wireless driver (CT version)' >> package/kernel/ath11k-ct/Makefile
              echo '  DEPENDS:=+kmod-cfg80211 +kmod-usb-core +kmod-mac80211' >> package/kernel/ath11k-ct/Makefile
              echo '  KCONFIG:= \' >> package/kernel/ath11k-ct/Makefile
              echo '    CONFIG_ATH11K=m \' >> package/kernel/ath11k-ct/Makefile
              echo '    CONFIG_ATH11K_DEBUGFS=n \' >> package/kernel/ath11k-ct/Makefile
              echo '    CONFIG_ATH11K_TRACE=n' >> package/kernel/ath11k-ct/Makefile
              echo '  FILES:=$(PKG_BUILD_DIR)/compat.ko $(PKG_BUILD_DIR)/ath11k.ko' >> package/kernel/ath11k-ct/Makefile
              echo '  AUTOLOAD:=$(call AutoProbe,ath11k)' >> package/kernel/ath11k-ct/Makefile
              echo 'endef' >> package/kernel/ath11k-ct/Makefile
              echo '' >> package/kernel/ath11k-ct/Makefile
              echo 'define KernelPackage/ath11k-ct/description' >> package/kernel/ath11k-ct/Makefile
              echo '  This package contains the Atheros ath11k wireless driver' >> package/kernel/ath11k-ct/Makefile
              echo '  for newer Qualcomm Atheros chipsets.' >> package/kernel/ath11k-ct/Makefile
              echo 'endef' >> package/kernel/ath11k-ct/Makefile
              echo '' >> package/kernel/ath11k-ct/Makefile
              echo '$(eval $(call KernelPackage,ath11k-ct))' >> package/kernel/ath11k-ct/Makefile
              
              echo "‚úÖ Â∑≤ÂàõÂª∫ath11k-ctÈ©±Âä®ÁöÑÂü∫Êú¨Makefile"
            fi
            
            # Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂
            rm -rf /tmp/openwrt-openwrt-23.05
          else
            echo "‚úÖ Â∑≤ÈÄöËøáÂÆòÊñπFeedsËé∑Âèñath11kÈ©±Âä®"
          fi
        else
          echo "‚úÖ IPQ5332 Wi-FiÈ©±Âä®Â∑≤ÂÆâË£Ö"
        fi

    - name: Âü∫Á°ÄÈÖçÁΩÆÁîüÊàêÔºà‰øùÁïôÂπ∂Âº∫ÂåñÁõÆÊ†áÂπ≥Âè∞Ôºâ
      run: |
        cd $OPENWRT_PATH
        # ‰øùÁïôÂéüÊúâ.configÈÖçÁΩÆÔºå‰ΩÜÁ°Æ‰øùÁõÆÊ†áÂπ≥Âè∞Ê≠£Á°ÆËÆæÁΩÆ
        if [ -f "$CONFIG_FILE" ]; then
          echo "‚úÖ Ê£ÄÊµãÂà∞Â∑≤ÊúâÈÖçÁΩÆÊñá‰ª∂Ôºå‰øùÁïôÂπ∂Êõ¥Êñ∞ÁõÆÊ†áÂπ≥Âè∞ÈÖçÁΩÆ"
          # Â§á‰ªΩÂéüÈÖçÁΩÆ
          cp $CONFIG_FILE ${CONFIG_FILE}.bak
          
          # Á°Æ‰øùÁõÆÊ†áÂπ≥Âè∞Ê≠£Á°ÆËÆæÁΩÆ
          sed -i '/CONFIG_TARGET_IPQ807X/d' $CONFIG_FILE
          sed -i '/CONFIG_TARGET_IPQ807X_DEVICE_jd-be6500/d' $CONFIG_FILE
          echo "CONFIG_TARGET_IPQ807X=y" >> $CONFIG_FILE
          echo "CONFIG_TARGET_IPQ807X_DEVICE_jd-be6500=y" >> $CONFIG_FILE
          echo "CONFIG_TARGET_DEVICE_PACKAGES_jd-be6500=\"kmod-ath11k-ct kmod-qca-ppe kmod-qca-nss-drv kmod-qca-nss-gmac kmod-thermal-qcom\"" >> $CONFIG_FILE
          echo "CONFIG_TARGET_KERNEL_PARTSIZE=16" >> $CONFIG_FILE
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=128" >> $CONFIG_FILE
        else
          # ÁîüÊàêÈªòËÆ§ÈÖçÁΩÆ
          make defconfig
          
          # ËÆæÁΩÆÁõÆÊ†áÂπ≥Âè∞
          echo "CONFIG_TARGET_IPQ807X=y" >> $CONFIG_FILE
          echo "CONFIG_TARGET_IPQ807X_DEVICE_jd-be6500=y" >> $CONFIG_FILE
          echo "CONFIG_TARGET_DEVICE_PACKAGES_jd-be6500=\"kmod-ath11k-ct kmod-qca-ppe kmod-qca-nss-drv kmod-qca-nss-gmac kmod-thermal-qcom\"" >> $CONFIG_FILE
          echo "CONFIG_TARGET_KERNEL_PARTSIZE=16" >> $CONFIG_FILE
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=128" >> $CONFIG_FILE
        fi
        
        # ÊòæÁ§∫ÂΩìÂâçÈÖçÁΩÆÔºàÁî®‰∫éË∞ÉËØïÔºâ
        echo "=== ÂΩìÂâç.config ËÆæÂ§áÈÖçÁΩÆ ==="
        grep -E "CONFIG_TARGET_IPQ807X_DEVICE|CONFIG_TARGET_DEVICE_PACKAGES" .config

    - name: ËÆæÂ§áÊ†ëÂº∫Âà∂ÂÖ≥ËÅîÔºàÂÖ≥ÈîÆ‰øÆÊ≠£Ôºâ
      run: |
        cd $OPENWRT_PATH
        echo "=== Âº∫Âà∂ÂÖ≥ËÅîËÆæÂ§áÊ†ëÂà∞ÁºñËØëÁ≥ªÁªü ==="
        
        # 1. Á°Æ‰øùËÆæÂ§áÊ†ëÁõÆÂΩïÂ≠òÂú®
        DTS_DIR="target/linux/$ARCH/dts"
        mkdir -p "$DTS_DIR"
        
        # 2. Â§çÂà∂ÊàñÁîüÊàêËÆæÂ§áÊ†ëÊñá‰ª∂
        DEVICE_TREE="$DTS_DIR/qcom,ipq5332-jd-be6500.dts"
        if [ ! -f "$DEVICE_TREE" ]; then
          echo "‚ùå ËÆæÂ§áÊ†ë‰∏çÂ≠òÂú®Ôºå‰ªéÁºìÂ≠òÂ§çÂà∂ÊàñÁîüÊàê..."
          # ÂÅáËÆæËÆæÂ§áÊ†ëÂ∑≤Â≠òÂú®‰∫é‰ªìÂ∫ì‰∏≠ÔºåÊàñ‰ªéÁºìÂ≠òÂ§çÂà∂
          if [ -f "qcom,ipq5332-jd-be6500.dts" ]; then
            cp "qcom,ipq5332-jd-be6500.dts" "$DEVICE_TREE"
          else
            # ÁîüÊàêËÆæÂ§áÊ†ë
            echo '/dts-v1/;' > "$DEVICE_TREE"
            echo '#include "qcom,ipq5332.dtsi"' >> "$DEVICE_TREE"
            echo '#include "ipq807x.dtsi"' >> "$DEVICE_TREE"
            echo '' >> "$DEVICE_TREE"
            echo '/ {' >> "$DEVICE_TREE"
            echo '    model = "JD BE6500";' >> "$DEVICE_TREE"
            echo '    compatible = "qcom,ipq5332", "qcom,ipq5000", "qcom,ipq807x";' >> "$DEVICE_TREE"
            echo '    # ÁÆÄÂåñËÆæÂ§áÊ†ëÂÜÖÂÆπÔºåÂÆûÈôÖÂ∫î‰ΩøÁî®ÂÆåÊï¥ÈÖçÁΩÆ' >> "$DEVICE_TREE"
            echo '};' >> "$DEVICE_TREE"
          fi
          echo "ËÆæÂ§áÊ†ëÂ∑≤ÁîüÊàê: $DEVICE_TREE"
        else
          echo "‚úÖ ËÆæÂ§áÊ†ëÂ∑≤Â≠òÂú®"
        fi
        
        # 3. Á°Æ‰øùËÆæÂ§áÊ†ëË¢´MakefileËØÜÂà´ÔºàÂÖ≥ÈîÆ‰øÆÊ≠£Ôºâ
        MAKEFILE="target/linux/$ARCH/Makefile"
        if ! grep -q "jd-be6500" "$MAKEFILE"; then
          echo "‚ùå ËÆæÂ§áÊ†ëÊú™Ë¢´MakefileËØÜÂà´ÔºåÊâãÂä®Ê∑ªÂä†..."
          
          # Â§á‰ªΩÂéüMakefile
          cp "$MAKEFILE" "${MAKEFILE}.bak"
          
          # Ê∑ªÂä†ËÆæÂ§áÂÆö‰πâ
          sed -i "/define Device/generic/a\ \ \ \ \ DEVICE_PACKAGES += kmod-ath11k-ct kmod-qca-ppe kmod-qca-nss-drv kmod-qca-nss-gmac kmod-thermal-qcom" "$MAKEFILE"
          sed -i "/endef/a\ \ \ \ \ DEVICE_DTS := qcom,ipq5332-jd-be6500" "$MAKEFILE"
          
          if ! grep -q "qcom,ipq5332-jd-be6500" "$MAKEFILE"; then
            # Â¶ÇÊûúsedÂ§±Ë¥•Ôºå‰ΩøÁî®ËøΩÂä†ÊñπÂºè
            echo "" >> "$MAKEFILE"
            echo "define Device/jd-be6500" >> "$MAKEFILE"
            echo "  \$(Device/generic)" >> "$MAKEFILE"
            echo "  DEVICE_TITLE := JD BE6500 (IPQ5332)" >> "$MAKEFILE"
            echo "  DEVICE_DTS := qcom,ipq5332-jd-be6500" >> "$MAKEFILE"
            echo "  DEVICE_PACKAGES := kmod-ath11k-ct kmod-qca-ppe kmod-qca-nss-drv kmod-qca-nss-gmac kmod-thermal-qcom" >> "$MAKEFILE"
            echo "endef" >> "$MAKEFILE"
            echo "\$(eval \$(call Device,jd-be6500))" >> "$MAKEFILE"
          fi
          
          if grep -q "jd-be6500" "$MAKEFILE"; then
            echo "‚úÖ ËÆæÂ§áÊ†ëÂ∑≤Ê∑ªÂä†Âà∞Makefile"
          else
            echo "‚ùå ËÆæÂ§áÊ†ëÊ∑ªÂä†Â§±Ë¥•"
            exit 1
          fi
        else
          echo "‚úÖ ËÆæÂ§áÊ†ëÂ∑≤Ë¢´MakefileËØÜÂà´"
        fi

    - name: Â∫îÁî®diy-part1.shËÑöÊú¨ÔºàËá™ÂÆö‰πâÈÖçÁΩÆÔºâ
      run: |
        cd $OPENWRT_PATH
        if [ -f "$DIY_P1_SH" ]; then
          echo "ÊâßË°åËá™ÂÆö‰πâËÑöÊú¨: $DIY_P1_SH"
          chmod +x $DIY_P1_SH
          ./$DIY_P1_SH
        else
          echo "‚ùå Ëá™ÂÆö‰πâËÑöÊú¨‰∏çÂ≠òÂú®: $DIY_P1_SH"
        fi

    - name: Â∫îÁî®diy-part2.shËÑöÊú¨ÔºàËá™ÂÆö‰πâÈÖçÁΩÆÔºâ
      run: |
        cd $OPENWRT_PATH
        if [ -f "$DIY_P2_SH" ]; then
          echo "ÊâßË°åËá™ÂÆö‰πâËÑöÊú¨: $DIY_P2_SH"
          chmod +x $DIY_P2_SH
          ./$DIY_P2_SH
        else
          echo "‚ùå Ëá™ÂÆö‰πâËÑöÊú¨‰∏çÂ≠òÂú®: $DIY_P2_SH"
        fi

    - name: Ê∏ÖÁêÜÂèØËÉΩÁöÑÊçüÂùèÂåÖ‰ø°ÊÅØÔºàÊñ∞Â¢ûÊ≠•È™§Ôºâ
      run: |
        cd $OPENWRT_PATH
        echo "Ê∏ÖÁêÜÂèØËÉΩÁöÑÊçüÂùèÂåÖ‰ø°ÊÅØ..."
        
        # Ê∏ÖÁêÜpackageÁ¥¢ÂºïÁºìÂ≠ò
        rm -rf .package-lists/
        
        # Ê£ÄÊü•Âπ∂Ê∏ÖÁêÜÊçüÂùèÁöÑMakefile
        find package feeds -name "Makefile" -exec grep -q "^#" {} \; -exec echo "Ê∏ÖÁêÜÊ≥®ÈáäÂºÄÂ§¥ÁöÑMakefile: {}" \; -exec rm -f {} \; || true
        
        # Ê£ÄÊü•Âπ∂‰øÆÂ§çpackageÁõÆÂΩïÊùÉÈôê
        chmod -R 755 package feeds
        
        # ÈáçÊñ∞ÂàùÂßãÂåñfeeds
        ./scripts/feeds clean
        ./scripts/feeds install -a

    - name: Êî∂ÈõÜÂåÖ‰ø°ÊÅØÔºàÂ∏¶ËØ¶ÁªÜÊó•ÂøóÂíåÈîôËØØÂ§ÑÁêÜÔºâ
      run: |
        cd $OPENWRT_PATH
        echo "ÂºÄÂßãÊî∂ÈõÜÂåÖ‰ø°ÊÅØ..."
        
        # ÂàõÂª∫ËØ¶ÁªÜÊó•ÂøóÁõÆÂΩï
        mkdir -p package_info_logs
        
        # ÊâßË°åÂåÖ‰ø°ÊÅØÊî∂ÈõÜÔºåËæìÂá∫ËØ¶ÁªÜÊó•Âøó
        ./scripts/feeds list > package_info_logs/feeds_list.log 2>&1
        
        # Êî∂ÈõÜÂåÖ‰ø°ÊÅØÔºà‰ΩøÁî®ÂçïÁã¨ÁöÑËæìÂá∫Êñá‰ª∂Ôºâ
        make defconfig V=s > package_info_logs/defconfig.log 2>&1
        MAKE_STATUS=$?
        
        # Ê£ÄÊü•ÊòØÂê¶ÊúâÈîôËØØ
        if [ $MAKE_STATUS -ne 0 ]; then
          echo "‚ùå Êî∂ÈõÜÂåÖ‰ø°ÊÅØÂ§±Ë¥•ÔºåÂàÜÊûêÈîôËØØ..."
          
          # ÊèêÂèñÂÖ≥ÈîÆÈîôËØØ‰ø°ÊÅØ
          echo "=== ÂåÖ‰ø°ÊÅØÊî∂ÈõÜÈîôËØØÊëòË¶Å ==="
          grep -E "error:|fatal:|No such file or directory|cannot find|missing|failed" package_info_logs/defconfig.log || true
          
          # Ê£ÄÊü•ÊòØÂê¶ÊúâÁâπÂÆöÂåÖÂØºËá¥ÈóÆÈ¢ò
          echo "=== Ê£ÄÊü•ÂèØËÉΩÊúâÈóÆÈ¢òÁöÑÂåÖ ==="
          if grep -q "feeds/packages" package_info_logs/defconfig.log; then
            echo "‚ö†Ô∏è ÈóÆÈ¢òÂèØËÉΩÂá∫Âú®packages feed‰∏≠"
            # Â∞ùËØïÁ¶ÅÁî®ÂèØËÉΩÊúâÈóÆÈ¢òÁöÑÂåÖ
            echo "Â∞ùËØïÁ¶ÅÁî®ÂèØËÉΩÊúâÈóÆÈ¢òÁöÑÂåÖ..."
            sed -i '/feeds\/packages\/utils\/yq/d' .config
            sed -i '/feeds\/packages\/utils\/zsh/d' .config
            # ÈáçÊñ∞Â∞ùËØï
            make defconfig V=s > package_info_logs/defconfig_retry.log 2>&1
            if [ $? -eq 0 ]; then
              echo "‚úÖ Á¶ÅÁî®ÈóÆÈ¢òÂåÖÂêéÊàêÂäüÊî∂ÈõÜ‰ø°ÊÅØ"
            else
              echo "‚ùå ‰ªçÁÑ∂Â§±Ë¥•Ôºå‰øùÂ≠òÂÆåÊï¥Êó•Âøó"
              tar -czf package_info_error.tar.gz package_info_logs
              exit 1
            fi
          else
            echo "‚ùå Êó†Ê≥ïÁ°ÆÂÆöÂÖ∑‰ΩìÈóÆÈ¢òÂåÖÔºå‰øùÂ≠òÂÆåÊï¥Êó•Âøó"
            tar -czf package_info_error.tar.gz package_info_logs
            exit 1
          fi
        else
          echo "‚úÖ ÂåÖ‰ø°ÊÅØÊî∂ÈõÜÊàêÂäü"
        fi

    - name: ‰∏ãËΩΩ‰æùËµñÂåÖÔºàÂ∏¶ÁºìÂ≠òÔºâ
      run: |
        cd $OPENWRT_PATH
        echo "ÂºÄÂßã‰∏ãËΩΩ‰æùËµñÂåÖ..."
        
        # ‰ºòÂÖà‰ΩøÁî®ÁºìÂ≠ò
        if [ -d "${{ env.CACHE_DIR }}/dl" ]; then
          echo "‰ΩøÁî®ÁºìÂ≠ò‰æùËµñÂåÖ..."
          cp -rf "${{ env.CACHE_DIR }}/dl" .
        fi
        
        # ÊâßË°å‰∏ãËΩΩ
        make download -j$(nproc) V=s
        DOWNLOAD_STATUS=$?
        
        # ‰øùÂ≠òÁºìÂ≠ò
        mkdir -p "${{ env.CACHE_DIR }}/dl"
        cp -rf dl/* "${{ env.CACHE_DIR }}/dl/"
        
        # Ê∏ÖÁêÜÊó†ÊïàÊñá‰ª∂
        find dl -size -1024c -exec rm -f {} \;
        
        if [ $DOWNLOAD_STATUS -ne 0 ]; then
          echo "‚ö†Ô∏è ‰∏ãËΩΩÂèØËÉΩÂ≠òÂú®ÈîôËØØÔºåÁªßÁª≠ÊûÑÂª∫..."
          find dl -type f -empty -exec echo "Á©∫Êñá‰ª∂: {}" \;
        else
          echo "‚úÖ ‰æùËµñ‰∏ãËΩΩÂÆåÊàê"
          echo "‰∏ãËΩΩÊñá‰ª∂Êï∞: $(find dl -type f | wc -l)"
        fi

    - name: ÁºñËØëÂõ∫‰ª∂ÔºàÂ∏¶ËØ¶ÁªÜÈîôËØØÊó•ÂøóÔºâ
      run: |
        cd $OPENWRT_PATH
        echo "ÂºÄÂßãÁºñËØëÂõ∫‰ª∂... (IPQ5332‰∏ìÁî®)"
        echo "‰ΩøÁî® $(nproc) Á∫øÁ®ãÁºñËØë..."
        
        # ÈÖçÁΩÆÁºñËØëÁ∫øÁ®ãÊï∞ÔºàÊ†πÊçÆCPUÊ†∏ÂøÉÊï∞Ëá™Âä®Ë∞ÉÊï¥Ôºâ
        JOBS=$(nproc)
        if [ $JOBS -gt 4 ]; then
          JOBS=4  # ÈôêÂà∂ÊúÄÂ§ßÁ∫øÁ®ãÊï∞‰∏∫4ÔºåÈÅøÂÖçÂÜÖÂ≠ò‰∏çË∂≥
        fi
        
        # ÁîüÊàêÈÖçÁΩÆÔºàÁ°Æ‰øùÁõÆÊ†áÊ≠£Á°ÆÔºâ
        make defconfig
        
        # Á¨¨‰∏ÄÈò∂ÊÆµÔºöÂπ∂Ë°åÁºñËØë
        make -j$JOBS V=s 2>&1 | tee compile_phase1.log
        PHASE1_STATUS=$?
        
        if [ $PHASE1_STATUS -ne 0 ]; then
          echo "‚ùå Âπ∂Ë°åÁºñËØëÂ§±Ë¥•ÔºåÂ∞ùËØïÂçïÁ∫øÁ®ãÁºñËØë..."
          # Á¨¨‰∫åÈò∂ÊÆµÔºöÂçïÁ∫øÁ®ãÁºñËØëÔºàËé∑ÂèñËØ¶ÁªÜÈîôËØØÔºâ
          make -j1 V=s 2>&1 | tee compile_phase2.log
          PHASE2_STATUS=$?
          
          if [ $PHASE2_STATUS -ne 0 ]; then
            echo "üí• ÁºñËØëÂΩªÂ∫ïÂ§±Ë¥•ÔºåÊî∂ÈõÜÈîôËØØÊó•Âøó..."
            # ÊèêÂèñÂÖ≥ÈîÆÈîôËØØ‰ø°ÊÅØ
            echo "=== ÁºñËØëÈîôËØØÊëòË¶Å ==="
            grep -E "error:|fatal:|make\[.*:.*Error\]" compile_phase2.log || true
            
            # ‰øùÂ≠òÂÆåÊï¥Êó•Âøó
            mkdir -p error_logs
            cp compile_phase*.log error_logs/
            cp $(find . -name "*.err" -or -name "*.log") error_logs/ 2>/dev/null
            tar -czf error_logs.tar.gz error_logs
            exit 1
          else
            echo "‚úÖ ÂçïÁ∫øÁ®ãÁºñËØëÊàêÂäü"
          fi
        else
          echo "‚úÖ Âπ∂Ë°åÁºñËØëÊàêÂäü"
        fi

    - name: Âõ∫‰ª∂ÂÆåÊï¥ÊÄßÊ£ÄÊü•ÔºàÂ§öÁ∫ßË∑ØÂæÑÊ£ÄÊµã - ÂÖ≥ÈîÆ‰øÆÊ≠£Ôºâ
      run: |
        cd $OPENWRT_PATH
        # Ê£ÄÊµãipq807xÁõÆÊ†áÂõ∫‰ª∂Ë∑ØÂæÑÔºà‰øÆÊ≠£ÂëΩÂêçÈîôËØØÔºâ
        FIRMWARE_PATH=$(find . -type d -name "ipq807x" 2>/dev/null | head -n1)
        if [ -n "$FIRMWARE_PATH" ]; then
          FIRMWARE_PATH="$FIRMWARE_PATH/generic"
        else
          FIRMWARE_PATH=$(find . -type d -name "qcom" 2>/dev/null | head -n1)
          if [ -n "$FIRMWARE_PATH" ]; then
            FIRMWARE_PATH="$FIRMWARE_PATH/generic"
          else
            FIRMWARE_PATH=$(find . -type d -name "generic" 2>/dev/null | grep -E "ipq807x|qcom" | head -n1)
            if [ -z "$FIRMWARE_PATH" ]; then
              echo "‚ùå Êú™ÊâæÂà∞ipq807x/qcomÁõÆÊ†áÁõÆÂΩï"
              echo "ÂèØÁî®ÁõÆÊ†áÁõÆÂΩï:"
              find . -type d -name "*" | grep targets
              exit 1
            fi
          fi
        fi
        
        if [ ! -d "$FIRMWARE_PATH" ]; then
          FIRMWARE_PATH=$(find . -type d -name "bin" 2>/dev/null | head -n1)
          if [ -n "$FIRMWARE_PATH" ]; then
            FIRMWARE_PATH="$FIRMWARE_PATH/$ARCH/$SUBARCH"
          fi
        fi
        
        if [ ! -d "$FIRMWARE_PATH" ]; then
          echo "‚ùå Êú™ÊâæÂà∞ÈÄöÁî®Âõ∫‰ª∂ÁõÆÂΩï"
          echo "ÂèØÁî®ÁõÆÂΩï:"
          find . -type d -name "bin"
          exit 1
        fi
        
        echo "FIRMWARE_PATH=$FIRMWARE_PATH" >> $GITHUB_ENV
        
        # Ê£ÄÊü•ÂÖ≥ÈîÆÂõ∫‰ª∂Êñá‰ª∂Ôºà‰øÆÊ≠£ÂëΩÂêçËßÑÂàôÔºâ
        REQUIRED_FILES=(
          "openwrt-$ARCH-$SUBARCH-generic-jd-be6500-squashfs-sysupgrade.bin"
          "openwrt-$ARCH-$SUBARCH-generic-rootfs.tar.gz"
          "openwrt-$ARCH-$SUBARCH-generic-ext4-fsck"
        )
        
        MISSING_FILES=()
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$FIRMWARE_PATH/$file" ]; then
            MISSING_FILES+=($file)
          fi
        done
        
        if [ ${#MISSING_FILES[@]} -gt 0 ]; then
          echo "‚ùå ÂèëÁé∞Áº∫Â§±Âõ∫‰ª∂Êñá‰ª∂: ${MISSING_FILES[*]}"
          echo "ÂèØÁî®Êñá‰ª∂:"
          ls -lh $FIRMWARE_PATH/* || true
          
          # Â∞ùËØïÊü•ÊâæÂÖ∂‰ªñÂèØËÉΩÁöÑÂõ∫‰ª∂Êñá‰ª∂
          echo "ÂÖ∂‰ªñÂèØËÉΩÁöÑÂõ∫‰ª∂Êñá‰ª∂:"
          ls -lh $FIRMWARE_PATH/*jd-be6500* || true
          exit 1
        else
          echo "‚úÖ ÊâÄÊúâÂÖ≥ÈîÆÂõ∫‰ª∂Êñá‰ª∂Â∑≤ÁîüÊàê"
          ls -lh $FIRMWARE_PATH/*.bin
        fi

    - name: ÁîüÊàêÁâàÊú¨‰ø°ÊÅØ
      id: version
      run: |
        cd $OPENWRT_PATH
        RELEASE_DATE=$(date +%Y%m%d)
        COMMIT_ID=$(git rev-parse --short HEAD)
        BUILD_TIME=$(date +"%Y-%m-%d %H:%M:%S")
        BUILD_HOST=$(hostname)
        
        # ÁîüÊàêÁâàÊú¨‰ø°ÊÅØÊñá‰ª∂
        touch version.info
        echo "OpenWrt Âõ∫‰ª∂ for JD BE6500 (IPQ5332)" > version.info
        echo "ÁºñËØëÊó∂Èó¥: $BUILD_TIME" >> version.info
        echo "ÁºñËØë‰∏ªÊú∫: $BUILD_HOST" >> version.info
        echo "Git Êèê‰∫§: $COMMIT_ID" >> version.info
        echo "Lienol ÂàÜÊîØ: $LIENOL_BRANCH" >> version.info
        echo "ÁõÆÊ†áÂπ≥Âè∞: $ARCH/$SUBARCH" >> version.info
        
        # ËæìÂá∫ÁâàÊú¨ÂèòÈáè
        echo "release_version=OpenWrt_${RELEASE_DATE}_${COMMIT_ID}" >> $GITHUB_ENV
        echo "release_version=OpenWrt_${RELEASE_DATE}_${COMMIT_ID}" >> $GITHUB_OUTPUT
        cat version.info

    - name: ‰∏ä‰º†Âõ∫‰ª∂Âà∞Artifact
      if: env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.release_version }}
        path: |
          ${{ env.FIRMWARE_PATH }}/*.bin
          ${{ env.FIRMWARE_PATH }}/*.tar.gz
          ${{ env.FIRMWARE_PATH }}/sha256sums
          version.info
        retention-days: 30
        if-no-files-found: error

    - name: ÂèëÂ∏ÉÂà∞GitHub Release
      if: env.UPLOAD_RELEASE == 'true' && github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ env.release_version }}
        tag_name: ${{ env.release_version }}
        body_path: version.info
        files: |
          ${{ env.FIRMWARE_PATH }}/*.bin
          ${{ env.FIRMWARE_PATH }}/*.tar.gz
          ${{ env.FIRMWARE_PATH }}/sha256sums
          version.info
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.MY_TOKEN }}    
