name: Build OpenWrt for JD BE6500 (IPQ5332)

on:
  workflow_dispatch:  # ÊâãÂä®Ëß¶Âèë
    inputs:
      with_wsdd2:
        description: 'ÁºñËØëÂåÖÂê´ WSDD2 (SMB3 ÊîØÊåÅ)'
        required: false
        default: 'true'
        type: boolean
      with_samba4:
        description: 'ÁºñËØëÂåÖÂê´ Samba4'
        required: false
        default: 'true'
        type: boolean
  release:
    types: published  # ÂèëÂ∏ÉReleaseÊó∂Ëß¶Âèë

env:
  LIENOL_REPO: https://github.com/Lienol/openwrt          # Lienol‰∏ª‰ªìÂ∫ì
  LIENOL_BRANCH: 23.05                                  # ‰ΩøÁî®23.05ÂàÜÊîØ
  ARCH: ipq807x                                          # ‰ΩøÁî®ipq807xÁõÆÊ†áÔºàÂÖºÂÆπIPQ5332Ôºâ
  SUBARCH: generic                                       # ÈÄöÁî®Â≠êÊû∂ÊûÑ
  CPU_ARCH: aarch64_cortex-a53                           # CPUÊû∂ÊûÑ
  FEEDS_CONF: feeds.conf.default                         # FeedsÈÖçÁΩÆÊñá‰ª∂
  CONFIG_FILE: .config                                   # ÁºñËØëÈÖçÁΩÆÊñá‰ª∂
  DIY_P1_SH: diy-part1.sh                                # Ëá™ÂÆö‰πâËÑöÊú¨1
  DIY_P2_SH: diy-part2.sh                                # Ëá™ÂÆö‰πâËÑöÊú¨2
  UPLOAD_BIN_DIR: false                                  # ‰∏ç‰∏ä‰º†binÁõÆÂΩï
  UPLOAD_FIRMWARE: true                                  # ‰∏ä‰º†Âõ∫‰ª∂
  UPLOAD_RELEASE: true                                   # ÂèëÂ∏ÉÂà∞Release
  UPLOAD_CDN: false                                      # ‰∏ä‰º†Âà∞CDN
  TZ: Asia/Shanghai                                      # Êó∂Âå∫
  GITHUB_TOKEN: ${{ secrets.MY_TOKEN }}                  # GitHub Token
  CACHE_DIR: ${{ github.workspace }}/.cache/openwrt       # ÁºìÂ≠òÁõÆÂΩï

jobs:
  build:
    runs-on: ubuntu-22.04                                 # ËøêË°åÁéØÂ¢É
    container:
      image: openwrt/sdk:23.05.0-x86-64                   # ‰ΩøÁî®ÂÆòÊñπSDKÂÆπÂô®

    steps:
    - name: Ê£ÄÊü•ÁéØÂ¢É
      run: |
        df -hT
        free -h
        cat /proc/cpuinfo
        cat /etc/os-release

    - name: ÂÆâË£ÖÂü∫Á°Ä‰æùËµñ
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential subversion git-core libncurses5-dev zlib1g-dev gawk flex quilt libssl-dev xsltproc libxml-parser-perl mercurial bzr ecj cvs unzip python3-distutils file wget upx-ucl python3-pip
        sudo pip install requests tqdm  # Áî®‰∫é‰∏ãËΩΩËæÖÂä©
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android/sdk

    - name: ÈÖçÁΩÆGitÂá≠ËØÅ
      run: |
        git config --global credential.helper store
        echo "https://${GITHUB_TOKEN}:@github.com" > ~/.git-credentials
        echo "GitÂá≠ËØÅÂ∑≤ÈÖçÁΩÆ"

    - name: ÂÖãÈöÜLienol‰ªìÂ∫ìÔºàÂ∏¶ÈáçËØïÊú∫Âà∂Ôºâ
      run: |
        rm -rf openwrt
        for i in {1..5}; do
          echo "=== Á¨¨ $i Ê¨°ÂÖãÈöÜÂ∞ùËØï ==="
          git clone --depth=1 $LIENOL_REPO -b $LIENOL_BRANCH openwrt
          if [ $? -eq 0 ]; then
            echo "‚úÖ ‰ªìÂ∫ìÂÖãÈöÜÊàêÂäü"
            break
          fi
          echo "‚ùå ÂÖãÈöÜÂ§±Ë¥•Ôºå15ÁßíÂêéÈáçËØï..."
          sleep 15
        done
        if [ ! -d "openwrt" ]; then
          echo "üí• ‰∫îÊ¨°ÂÖãÈöÜÂ§±Ë¥•ÔºåÈÄÄÂá∫"
          exit 1
        fi
        cd openwrt
        echo "OPENWRT_PATH=$(pwd)" >> $GITHUB_ENV
        git log -1

    - name: ÁºìÂ≠ò‰æùËµñÂåÖÔºàÂä†ÈÄüÁºñËØëÔºâ
      uses: actions/cache@v3
      with:
        path: ${{ env.CACHE_DIR }}
        key: ${{ runner.os }}-openwrt-dl-${{ hashFiles('openwrt/dl/**') }}
        restore-keys: |
          ${{ runner.os }}-openwrt-dl-

    - name: ÂàõÂª∫ËÆæÂ§áÊ†ëÔºàIPQ5332ÈÄÇÈÖçÔºâ
      run: |
        cd $OPENWRT_PATH
        DEVICE_TREE="qcom,ipq5332-jd-be6500.dts"
        DTS_DIR="target/linux/$ARCH/dts"
        mkdir -p "$DTS_DIR"
        
        # ËÆæÂ§áÊ†ëÂÆåÊï¥ÊÄßÊ†°È™å
        if [ ! -f "$DTS_DIR/$DEVICE_TREE" ]; then
          echo "ÁîüÊàêJD BE6500ËÆæÂ§áÊ†ë..."
          > "$DTS_DIR/$DEVICE_TREE"
          
          # Ê†∏ÂøÉËÆæÂ§áÊ†ëÈÖçÁΩÆÔºàÂÖ≥ÈîÆÔºöÂÖºÂÆπipq807xÁõÆÊ†áÔºâ
          cat > "$DTS_DIR/$DEVICE_TREE" << 'EOF'
/dts-v1/;
#include "qcom,ipq5332.dtsi"
#include "ipq807x.dtsi"

/ {
  model = "JD BE6500";
  compatible = "qcom,ipq5332", "qcom,ipq5000", "qcom,ipq807x";

  chosen {
    bootargs = "earlycon=msm_serial_dm,0x1a10000 console=ttyMSM0,115200n8";
  };

  memory@80000000 {
    device_type = "memory";
    reg = <0x80000000 0x40000000>; /* 1GB */
  };

  # ÁΩëÁªúÈÖçÁΩÆÔºàÊ†πÊçÆÂÆûÈôÖÁ°¨‰ª∂Ë∞ÉÊï¥Ôºâ
  ethernet@1a10000 {
    compatible = "qcom,ipq8074-gmac", "qcom,ipq8064-gmac";
    reg = <0x1a10000 0x10000>;
    interrupts = <0 42 4>;
    qcom,phy-handle = <&switch0_phy0>;
    qcom,mdio-bus = <&mdio>;
    qcom,port-id = <0>;
    qcom,rxq-pool = <0>;
    qcom,txq-pool = <0>;
    qcom,ptp-clock = <0>;
  };

  mdio@1a14000 {
    compatible = "qcom,ipq8074-mdio";
    reg = <0x1a14000 0x1000>;
    #address-cells = <1>;
    #size-cells = <0>;
  };
};
EOF
          echo "ËÆæÂ§áÊ†ëÂ∑≤ÁîüÊàê: $DTS_DIR/$DEVICE_TREE"
        else
          echo "ËÆæÂ§áÊ†ëÂ∑≤Â≠òÂú®ÔºåË∑≥ËøáÁîüÊàê"
        fi

    - name: Êô∫ËÉΩFeedsÈÖçÁΩÆÔºàÂéªÈáç+‰æùËµñ‰øÆÂ§çÔºâ
      run: |
        cd $OPENWRT_PATH
        # Â§á‰ªΩÂéüÂßãFeedsÈÖçÁΩÆ
        cp $FEEDS_CONF ${FEEDS_CONF}.bak
        
        # 1. Ê∏ÖÁêÜÈáçÂ§çÊ∫êÔºà‰øùÁïôÂîØ‰∏ÄÂÆû‰æãÔºâ
        UNIQUE_FEEDS=$(cat $FEEDS_CONF | grep -v '^#' | sort -u)
        > $FEEDS_CONF
        echo "$UNIQUE_FEEDS" >> $FEEDS_CONF
        
        # 2. Âº∫Âà∂Ê∑ªÂä†Ê†∏ÂøÉÊ∫êÔºàÁ°Æ‰øù‰æùËµñÂèØÁî®Ôºâ
        echo "src-git lienol https://github.com/Lienol/openwrt-package" >> $FEEDS_CONF
        echo "src-git kenzo https://github.com/kenzok8/openwrt-packages" >> $FEEDS_CONF
        echo "src-git small https://github.com/kenzok8/small" >> $FEEDS_CONF
        
        # 3. Ê∑ªÂä†ÂÆòÊñπÊ∫êÔºàË°•ÂÖÖÂü∫Á°ÄÂåÖÔºâ
        echo "src-gz openwrt_core https://downloads.openwrt.org/releases/23.05.0/targets/$ARCH/$SUBARCH/packages" >> $FEEDS_CONF
        echo "src-gz openwrt_base https://downloads.openwrt.org/releases/23.05.0/packages/$CPU_ARCH/base" >> $FEEDS_CONF
        echo "src-gz openwrt_luci https://downloads.openwrt.org/releases/23.05.0/packages/$CPU_ARCH/luci" >> $FEEDS_CONF
        echo "src-gz openwrt_packages https://downloads.openwrt.org/releases/23.05.0/packages/$CPU_ARCH/packages" >> $FEEDS_CONF
        
        # 4. ÊòæÁ§∫ÊúÄÁªàFeedsÈÖçÁΩÆ
        echo "=== ÊúÄÁªàFeedsÈÖçÁΩÆ ==="
        cat $FEEDS_CONF

    - name: ‰æùËµñÂº∫ÂåñÂÆâË£ÖÔºàËß£ÂÜ≥ÂéÜÂè≤Êä•ÈîôÔºâ
      run: |
        cd $OPENWRT_PATH
        # Ê∏ÖÁêÜÊóßFeeds
        rm -rf feeds/*
        
        # Â§öËΩÆFeedsÊõ¥Êñ∞ÔºàËß£ÂÜ≥ÁΩëÁªúÊ≥¢Âä®Ôºâ
        for i in {1..3}; do
          echo "=== Á¨¨ $i Ê¨°FeedsÊõ¥Êñ∞ ==="
          ./scripts/feeds update -a 2>&1 | tee feeds_update_${i}.log
          if [ $? -eq 0 ]; then
            break
          fi
          echo "Êõ¥Êñ∞Â§±Ë¥•Ôºå10ÁßíÂêéÈáçËØï..."
          sleep 10
        done
        
        # ÂÆâË£ÖFeedsÔºàÂ∏¶‰æùËµñ‰øÆÂ§çÔºâ
        ./scripts/feeds install -a 2>&1 | tee feeds_install.log
        
        # Ê£ÄÊµãÂπ∂ÂÆâË£ÖÁº∫Â§±ÁöÑÂÖ≥ÈîÆ‰æùËµñ
        MISSING_PACKAGES=()
        for pkg in luci-app-samba wsdd2 luci-app-samba4 libpam liblzma libnetsnmp; do
          if ! ./scripts/feeds list | grep -q $pkg; then
            MISSING_PACKAGES+=($pkg)
            echo "‚ö†Ô∏è Áº∫Â§±‰æùËµñ: $pkgÔºåÂ∞ùËØïÊâãÂä®Ê∑ªÂä†"
            
            # Ëá™Âä®ÂÖãÈöÜÁº∫Â§±ÁöÑÂåÖÔºàÁ§∫‰æãÔºöluci-app-sambaÔºâ
            if [ $pkg == "luci-app-samba" ]; then
              mkdir -p package/custom/luci
              git clone https://github.com/openwrt/luci.git package/custom/luci
            elif [ $pkg == "wsdd2" ]; then
              mkdir -p package/custom/wsdd2
              git clone https://github.com/gena01/wsdd2.git package/custom/wsdd2
            elif [ $pkg == "libpam" ]; then
              mkdir -p package/custom/packages
              git clone https://github.com/openwrt/packages.git package/custom/packages
            fi
          fi
        done
        
        if [ ${#MISSING_PACKAGES[@]} -gt 0 ]; then
          echo "ÂèëÁé∞ ${#MISSING_PACKAGES[@]} ‰∏™Áº∫Â§±‰æùËµñ: ${MISSING_PACKAGES[*]}"
          echo "ÈáçÊñ∞ÂÆâË£ÖFeeds..."
          ./scripts/feeds update -a
          ./scripts/feeds install -a
        else
          echo "‚úÖ ÊâÄÊúâ‰æùËµñÂ∑≤ÂÆâË£Ö"
        fi

    - name: Ëá™ÂÆö‰πâÁºñËØëÂâç‰øÆÊîπ (Part 1)
      run: |
        if [ -f "$GITHUB_WORKSPACE/scripts/$DIY_P1_SH" ]; then
          cd $OPENWRT_PATH
          chmod +x $GITHUB_WORKSPACE/scripts/$DIY_P1_SH
          echo "ÊâßË°åËá™ÂÆö‰πâËÑöÊú¨ $DIY_P1_SH..."
          $GITHUB_WORKSPACE/scripts/$DIY_P1_SH
        else
          echo "‚ö†Ô∏è Êú™ÊâæÂà∞Ëá™ÂÆö‰πâËÑöÊú¨Ôºå‰ΩøÁî®ÈªòËÆ§ÈÖçÁΩÆ"
        fi

    - name: Âü∫Á°ÄÈÖçÁΩÆÁîüÊàê
      run: |
        cd $OPENWRT_PATH
        # ÁîüÊàêÈªòËÆ§ÈÖçÁΩÆ
        make defconfig
        
        # ËÆæÁΩÆÁõÆÊ†áÂπ≥Âè∞ÔºàIPQ5332ÈÄÇÈÖçÔºâ
        sed -i 's|^# CONFIG_TARGET_ipq807x is not set|CONFIG_TARGET_ipq807x=y|' .config
        sed -i 's|^# CONFIG_TARGET_ipq807x_generic is not set|CONFIG_TARGET_ipq807x_generic=y|' .config
        sed -i 's|^# CONFIG_TARGET_IPQ807X_DEVICE_generic is not set|CONFIG_TARGET_IPQ807X_DEVICE_generic=y|' .config
        
        # ÂêØÁî®ÂøÖË¶ÅÁöÑÂü∫Á°ÄÂåÖ
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-ssl=y" >> .config
        echo "CONFIG_PACKAGE_kmod-ath11k-ct=y" >> .config       # Wi-Fi 7È©±Âä®
        echo "CONFIG_PACKAGE_kmod-qca-ppe=y" >> .config        # PPEÂä†ÈÄü
        echo "CONFIG_PACKAGE_fstools=y" >> .config             # Âõ∫‰ª∂Â∑•ÂÖ∑

    - name: Âä®ÊÄÅ‰æùËµñÈÖçÁΩÆÔºàÊ†πÊçÆËæìÂÖ•ÂèÇÊï∞Ôºâ
      run: |
        cd $OPENWRT_PATH
        # Ê†πÊçÆÁî®Êà∑ËæìÂÖ•ÂêØÁî®ÂäüËÉΩ
        if [ ${{ github.event.inputs.with_wsdd2 == 'true' ]]; then
          echo "CONFIG_PACKAGE_wsdd2=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-wsdd2=y" >> .config
        fi
        
        if [ ${{ github.event.inputs.with_samba4 == 'true' ]]; then
          echo "CONFIG_PACKAGE_samba4=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-samba4=y" >> .config
        fi
        
        # ‰øÆÂ§çÂéÜÂè≤‰æùËµñÈóÆÈ¢ò
        echo "CONFIG_PACKAGE_libpam=y" >> .config
        echo "CONFIG_PACKAGE_liblzma=y" >> .config
        echo "CONFIG_PACKAGE_libnetsnmp=y" >> .config
        
        # ÊòæÁ§∫ÂÖ≥ÈîÆÈÖçÁΩÆ
        echo "=== ÂÖ≥ÈîÆÈÖçÁΩÆ ==="
        grep -E "CONFIG_TARGET|CONFIG_PACKAGE_(samba|wsdd2|libpam)" .config

    - name: Ëá™ÂÆö‰πâÈÖçÁΩÆ‰øÆÊîπ (Part 2)
      run: |
        if [ -f "$GITHUB_WORKSPACE/scripts/$DIY_P2_SH" ]; then
          cd $OPENWRT_PATH
          chmod +x $GITHUB_WORKSPACE/scripts/$DIY_P2_SH
          echo "ÊâßË°åËá™ÂÆö‰πâÈÖçÁΩÆËÑöÊú¨ $DIY_P2_SH..."
          $GITHUB_WORKSPACE/scripts/$DIY_P2_SH
        else
          echo "‚ö†Ô∏è Êú™ÊâæÂà∞Ëá™ÂÆö‰πâËÑöÊú¨"
        fi

    - name: ‰∏ãËΩΩ‰æùËµñÂåÖÔºàÂ∏¶ÁºìÂ≠òÔºâ
      run: |
        cd $OPENWRT_PATH
        echo "ÂºÄÂßã‰∏ãËΩΩ‰æùËµñÂåÖ..."
        
        # ‰ºòÂÖà‰ΩøÁî®ÁºìÂ≠ò
        if [ -d "${{ env.CACHE_DIR }}/dl" ]; then
          echo "‰ΩøÁî®ÁºìÂ≠ò‰æùËµñÂåÖ..."
          cp -rf "${{ env.CACHE_DIR }}/dl" .
        fi
        
        # ÊâßË°å‰∏ãËΩΩ
        make download -j$(nproc) V=s
        DOWNLOAD_STATUS=$?
        
        # ‰øùÂ≠òÁºìÂ≠ò
        mkdir -p "${{ env.CACHE_DIR }}/dl"
        cp -rf dl/* "${{ env.CACHE_DIR }}/dl/"
        
        # Ê∏ÖÁêÜÊó†ÊïàÊñá‰ª∂
        find dl -size -1024c -exec rm -f {} \;
        
        if [ $DOWNLOAD_STATUS -ne 0 ]; then
          echo "‚ö†Ô∏è ‰∏ãËΩΩÂèØËÉΩÂ≠òÂú®ÈîôËØØÔºåÁªßÁª≠ÊûÑÂª∫..."
          find dl -type f -empty -exec echo "Á©∫Êñá‰ª∂: {}" \;
        else
          echo "‚úÖ ‰æùËµñ‰∏ãËΩΩÂÆåÊàê"
          echo "‰∏ãËΩΩÊñá‰ª∂Êï∞: $(find dl -type f | wc -l)"
        fi

    - name: ÁºñËØëÂõ∫‰ª∂ÔºàÂ∏¶ËØ¶ÁªÜÈîôËØØÊó•ÂøóÔºâ
      run: |
        cd $OPENWRT_PATH
        echo "ÂºÄÂßãÁºñËØëÂõ∫‰ª∂... (IPQ5332‰∏ìÁî®)"
        echo "‰ΩøÁî® $(nproc) Á∫øÁ®ãÁºñËØë..."
        
        # Á¨¨‰∏ÄÈò∂ÊÆµÔºöÂπ∂Ë°åÁºñËØë
        make -j$(nproc) V=s 2>&1 | tee compile_phase1.log
        PHASE1_STATUS=$?
        
        if [ $PHASE1_STATUS -ne 0 ]; then
          echo "‚ùå Âπ∂Ë°åÁºñËØëÂ§±Ë¥•ÔºåÂ∞ùËØïÂçïÁ∫øÁ®ãÁºñËØë..."
          # Á¨¨‰∫åÈò∂ÊÆµÔºöÂçïÁ∫øÁ®ãÁºñËØëÔºàËé∑ÂèñËØ¶ÁªÜÈîôËØØÔºâ
          make -j1 V=s 2>&1 | tee compile_phase2.log
          PHASE2_STATUS=$?
          
          if [ $PHASE2_STATUS -ne 0 ]; then
            echo "üí• ÁºñËØëÂΩªÂ∫ïÂ§±Ë¥•ÔºåÊî∂ÈõÜÈîôËØØÊó•Âøó..."
            # ÊèêÂèñÂÖ≥ÈîÆÈîôËØØ‰ø°ÊÅØ
            echo "=== ÁºñËØëÈîôËØØÊëòË¶Å ==="
            grep -E "error:|fatal:|make\[.*:.*Error\]" compile_phase2.log || true
            
            # ‰øùÂ≠òÂÆåÊï¥Êó•Âøó
            mkdir -p error_logs
            cp compile_phase*.log error_logs/
            cp $(find . -name "*.err" -or -name "*.log") error_logs/ 2>/dev/null
            tar -czf error_logs.tar.gz error_logs
            exit 1
          else
            echo "‚úÖ ÂçïÁ∫øÁ®ãÁºñËØëÊàêÂäü"
          fi
        else
          echo "‚úÖ Âπ∂Ë°åÁºñËØëÊàêÂäü"
        fi

    - name: Âõ∫‰ª∂ÂÆåÊï¥ÊÄßÊ£ÄÊü•
      run: |
        cd $OPENWRT_PATH/bin/targets/*/*
        FIRMWARE_PATH=$(pwd)
        echo "FIRMWARE_PATH=$FIRMWARE_PATH" >> $GITHUB_ENV
        
        # Ê£ÄÊü•ÂÖ≥ÈîÆÂõ∫‰ª∂Êñá‰ª∂
        REQUIRED_FILES=(
          "openwrt-$ARCH-$SUBARCH-generic-jd-be6500-squashfs-sysupgrade.bin"
          "openwrt-$ARCH-$SUBARCH-generic-rootfs.tar.gz"
          "openwrt-$ARCH-$SUBARCH-generic-ext4-fsck"
        )
        
        MISSING_FILES=()
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$FIRMWARE_PATH/$file" ]; then
            MISSING_FILES+=($file)
          fi
        done
        
        if [ ${#MISSING_FILES[@]} -gt 0 ]; then
          echo "‚ùå ÂèëÁé∞Áº∫Â§±Âõ∫‰ª∂Êñá‰ª∂: ${MISSING_FILES[*]}"
          echo "ÂèØÁî®Êñá‰ª∂:"
          ls -lh $FIRMWARE_PATH/* || true
          exit 1
        else
          echo "‚úÖ ÊâÄÊúâÂÖ≥ÈîÆÂõ∫‰ª∂Êñá‰ª∂Â∑≤ÁîüÊàê"
          ls -lh $FIRMWARE_PATH/*.bin
        fi

    - name: ÁîüÊàêÁâàÊú¨‰ø°ÊÅØ
      id: version
      run: |
        cd $OPENWRT_PATH
        RELEASE_DATE=$(date +%Y%m%d)
        COMMIT_ID=$(git rev-parse --short HEAD)
        BUILD_TIME=$(date +"%Y-%m-%d %H:%M:%S")
        BUILD_HOST=$(hostname)
        
        # ÁîüÊàêÁâàÊú¨‰ø°ÊÅØÊñá‰ª∂
        > version.info
        echo "OpenWrt Âõ∫‰ª∂ for JD BE6500 (IPQ5332)" >> version.info
        echo "ÁºñËØëÊó∂Èó¥: $BUILD_TIME" >> version.info
        echo "ÁºñËØë‰∏ªÊú∫: $BUILD_HOST" >> version.info
        echo "Git Êèê‰∫§: $COMMIT_ID" >> version.info
        echo "Lienol ÂàÜÊîØ: $LIENOL_BRANCH" >> version.info
        
        # ËæìÂá∫ÁâàÊú¨ÂèòÈáè
        echo "release_version=OpenWrt_${RELEASE_DATE}_${COMMIT_ID}" >> $GITHUB_ENV
        echo "release_version=OpenWrt_${RELEASE_DATE}_${COMMIT_ID}" >> $GITHUB_OUTPUT
        cat version.info

    - name: ‰∏ä‰º†Âõ∫‰ª∂Âà∞Artifact
      if: steps.version.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.release_version }}
        path: |
          ${{ env.FIRMWARE_PATH }}/*.bin
          ${{ env.FIRMWARE_PATH }}/*.tar.gz
          ${{ env.FIRMWARE_PATH }}/sha256sums
          version.info
        retention-days: 30
        if-no-files-found: error

    - name: ÂèëÂ∏ÉÂà∞GitHub Release
      if: steps.version.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ env.release_version }}
        tag_name: ${{ env.release_version }}
        body_path: version.info
        files: |
          ${{ env.FIRMWARE_PATH }}/*.bin
          ${{ env.FIRMWARE_PATH }}/*.tar.gz
          ${{ env.FIRMWARE_PATH }}/sha256sums
          version.info
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.MY_TOKEN }}
